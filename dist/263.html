<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Lesson</title>
    <style>
        /* --- 1. DESIGN SYSTEM --- */
        :root {
            --bg: #F5F7FA;
            --surface: #FFFFFF;
            --text: #2D3748;
            --text-light: #718096;
            --accent: #00838F; /* –ü–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç—Å—è –∏–∑ JSON */
            --accent-glow: rgba(0, 131, 143, 0.3);
            --border: #E2E8F0;
            --success: #48BB78;
            --error: #F56565;
            --radius: 16px;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.08);
            --font-ui: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Segoe UI", Roboto, sans-serif;
            --font-read: "Georgia", "Merriweather", serif;
            --sidebar-width: 350px;
        }
        
        [data-theme="dark"] {
            --bg: #111827;
            --surface: #1F2937;
            --text: #F7FAFC;
            --text-light: #A0AEC0;
            --border: #2D3748;
            --shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
            --accent-glow: rgba(0, 131, 143, 0.5);
        }

        * { box-sizing: border-box; }
        
        body {
            font-family: var(--font-ui);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            line-height: 1.7;
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        /* --- UI CONTROLS --- */
        .top-controls {
            position: fixed; top: 20px; right: 20px; z-index: 1000;
            display: flex; gap: 12px;
        }

        .ui-btn {
            background: rgba(255,255,255,0.6); backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            height: 44px; padding: 0 16px; border-radius: 22px;
            cursor: pointer; display: flex; align-items: center; gap: 8px; justify-content: center;
            color: var(--text); font-weight: 600; font-size: 0.9rem;
            transition: 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        [data-theme="dark"] .ui-btn { background: rgba(30, 40, 50, 0.6); border-color: rgba(255,255,255,0.1); }
        .ui-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); background: var(--surface); }
        .badge {
            background: var(--accent); color: white; font-size: 0.75rem; 
            padding: 2px 6px; border-radius: 10px; min-width: 20px; text-align: center;
        }

        /* Progress Bar */
        #progress-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 5px;
            background: transparent; z-index: 999; pointer-events: none;
        }
        #progress-bar {
            height: 100%; background: var(--accent);
            width: 0%; transition: width 0.1s linear;
            box-shadow: 0 0 10px var(--accent);
        }

        /* --- HERO --- */
        .hero {
            position: relative;
            background: linear-gradient(135deg, var(--accent), #2c3e50);
            color: white; padding: 100px 20px 80px;
            clip-path: ellipse(150% 100% at 50% 0%);
            margin-bottom: 60px; text-align: center;
            transition: background 0.5s;
        }
        .hero-tag { 
            display: inline-block; background: rgba(255,255,255,0.2); 
            padding: 6px 16px; border-radius: 30px; font-size: 0.8rem; font-weight: 700; margin-bottom: 20px;
        }
        .lesson-title { font-size: 3rem; margin: 0 0 15px 0; font-weight: 800; letter-spacing: -1px; line-height: 1.1; }
        
        /* --- LAYOUT --- */
        .layout {
            display: grid; grid-template-columns: 1fr 280px; gap: 60px;
            max-width: 1100px; margin: 0 auto; padding: 0 20px 100px;
        }
        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; }
            .sidebar-nav { display: none; } /* Hide nav sidebar on mobile, keeping word drawer logic separate */
        }

        /* --- BLOCKS --- */
        .block { margin-bottom: 60px; opacity: 0; transform: translateY(20px); transition: 0.6s ease-out; }
        .block.reveal { opacity: 1; transform: translateY(0); }
        
        .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .block-title { margin: 0; font-size: 1.6rem; font-weight: 800; color: var(--text); position: relative; padding-left: 15px; }
        .block-title::before { content:''; position:absolute; left:0; top:50%; transform:translateY(-50%); width:5px; height:24px; background:var(--accent); border-radius:4px; }
        
        .reading-text { font-family: var(--font-read); font-size: 1.25rem; color: var(--text); line-height: 1.8; }

        /* --- MAGIC WORDS & TOOLTIP --- */
        .word { 
            cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; border-radius: 4px; padding: 0 1px;
        }
        .word:hover { background-color: var(--accent-glow); border-bottom-color: var(--accent); }
        .word.active { background-color: var(--accent); color: white; }
        .word.saved { border-bottom: 2px solid var(--success); } /* Visual indicator for saved words */

        /* Tooltip Styles */
        #tooltip {
            position: absolute; z-index: 2000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            padding: 12px 16px; border-radius: 12px;
            box-shadow: 0 10px 40px -10px rgba(0,0,0,0.2);
            border: 1px solid var(--border);
            pointer-events: none; opacity: 0; transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px); min-width: 150px;
        }
        [data-theme="dark"] #tooltip { background: rgba(30, 40, 50, 0.95); border-color: rgba(255,255,255,0.1); }
        #tooltip.visible { pointer-events: auto; opacity: 1; transform: translateY(0); }
        
        .tt-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .tt-word { font-weight: 800; font-size: 1.1rem; color: var(--text); text-transform: capitalize; }
        .tt-trans { font-size: 1rem; color: var(--accent); margin-bottom: 8px; font-weight: 500; }
        .tt-actions { display: flex; gap: 8px; margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border); }
        
        .tt-btn {
            flex: 1; padding: 6px; border-radius: 6px; border: none; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 4px;
        }
        .tt-btn-save { background: var(--surface); border: 1px solid var(--border); color: var(--text); }
        .tt-btn-save:hover { background: var(--accent); color: white; border-color: var(--accent); }
        .tt-btn-save.is-saved { background: var(--success); color: white; border-color: var(--success); }

        /* --- AUDIO BUTTON --- */
        .btn-audio {
            background: var(--surface); border: 1px solid var(--border);
            padding: 8px 16px; border-radius: 20px; color: var(--accent); font-weight: 600; cursor: pointer;
            display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-audio:hover { transform: translateY(-2px); border-color: var(--accent); }
        .btn-audio.playing { background: var(--accent); color: white; border-color: var(--accent); }
        .pulse-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; }
        .playing .pulse-dot { animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: scale(2.5); } }

        /* --- VOCABULARY CARDS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .v-item {
            background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border);
            text-align: center; cursor: pointer; transition: 0.3s; position: relative;
        }
        .v-item:hover { transform: translateY(-5px); border-color: var(--accent); box-shadow: var(--shadow); }
        .v-item .en { display: block; font-weight: 800; color: var(--accent); margin-bottom: 5px; }
        .v-item .ru { font-size: 0.9rem; color: var(--text-light); }
        
        .v-bookmark {
            position: absolute; top: 8px; right: 8px; width: 24px; height: 24px;
            display: flex; align-items: center; justify-content: center;
            border-radius: 50%; background: rgba(0,0,0,0.05); color: #ccc; transition: 0.2s;
        }
        .v-bookmark:hover { background: rgba(0,0,0,0.1); }
        .v-bookmark.saved { color: var(--accent); }

        /* --- QUIZ --- */
        .q-item { background: var(--surface); border: 1px solid var(--border); padding: 30px; border-radius: 16px; }
        .opts { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .opt-btn {
            padding: 15px; border: 2px solid var(--border); background: transparent; border-radius: 10px;
            text-align: left; cursor: pointer; color: var(--text); font-weight: 500; transition: 0.2s;
        }
        .opt-btn:hover { border-color: var(--accent); background: var(--bg); }
        .opt-btn.good { border-color: var(--success); background: rgba(72, 187, 120, 0.1); color: var(--success); }
        .opt-btn.bad { border-color: var(--error); background: rgba(245, 101, 101, 0.1); color: var(--error); animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        .fb { margin-top: 15px; padding: 10px; border-radius: 8px; background: var(--bg); display: none; }

        /* --- DRAWER (MY WORDS) --- */
        .drawer-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.3); backdrop-filter: blur(3px); z-index: 2000;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .drawer-overlay.open { opacity: 1; pointer-events: auto; }

        .drawer {
            position: fixed; top: 0; right: -400px; width: 400px; max-width: 85vw; height: 100%;
            background: var(--surface); z-index: 2001;
            box-shadow: -10px 0 40px rgba(0,0,0,0.1);
            transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        .drawer.open { right: 0; }

        .drawer-header {
            padding: 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .drawer-title { font-size: 1.2rem; font-weight: 800; }
        .drawer-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light); }
        
        .drawer-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        .saved-item {
            background: var(--bg); border-radius: 10px; padding: 15px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
            animation: slideInRight 0.3s ease;
        }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }
        .saved-info div:first-child { font-weight: 700; color: var(--accent); }
        .saved-info div:last-child { font-size: 0.9rem; color: var(--text-light); }
        .saved-actions { display: flex; gap: 5px; }
        .icon-btn { border: none; background: none; cursor: pointer; opacity: 0.6; transition: 0.2s; font-size: 1.1rem; }
        .icon-btn:hover { opacity: 1; transform: scale(1.1); }

        .drawer-footer { padding: 20px; border-top: 1px solid var(--border); }
        .btn-block { width: 100%; padding: 12px; border-radius: 10px; border: none; background: var(--accent); color: white; font-weight: 700; cursor: pointer; }
        .btn-block:hover { opacity: 0.9; }

        /* --- PRACTICE MODAL --- */
        .practice-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--surface); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .practice-modal.open { opacity: 1; pointer-events: auto; }
        .flashcard {
            width: 300px; height: 200px; perspective: 1000px; cursor: pointer; margin-bottom: 30px;
        }
        .flashcard-inner {
            width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d;
            position: relative; box-shadow: var(--shadow); border-radius: 20px;
        }
        .flashcard.flipped .flashcard-inner { transform: rotateY(180deg); }
        .fc-front, .fc-back {
            position: absolute; width: 100%; height: 100%;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; font-weight: 800; border-radius: 20px; border: 2px solid var(--border);
            background: var(--surface); color: var(--text); padding: 20px; text-align: center;
        }
        .fc-front { color: var(--accent); }
        .fc-back { transform: rotateY(180deg); background: var(--bg); color: var(--text); font-weight: 500; }
        
        /* Skeleton */
        .skeleton { background: linear-gradient(90deg, var(--border), var(--bg), var(--border)); background-size: 200%; animation: shimmer 1.5s infinite; border-radius: 6px; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    </style>
</head>
<body>

<!-- Top Controls -->
<div class="top-controls">
    <button class="ui-btn" onclick="vocabManager.toggleDrawer()">
        <span>‚òÖ My Words</span>
        <span class="badge" id="saved-count">0</span>
    </button>
    <button class="ui-btn" onclick="toggleTheme()" style="padding: 0 12px;">‚óë</button>
</div>

<!-- Tooltip Element -->
<div id="tooltip">
    <div class="tt-header">
        <span class="tt-word">Word</span>
        <button class="icon-btn" onclick="tooltipManager.hide()">‚úï</button>
    </div>
    <div class="tt-trans">Translation</div>
    <div class="tt-actions">
        <button class="tt-btn" onclick="tooltipManager.playCurrent()">üîä Listen</button>
        <button class="tt-btn tt-btn-save" id="tt-save-btn" onclick="tooltipManager.toggleSave()">+ Save</button>
    </div>
</div>

<!-- Drawer -->
<div class="drawer-overlay" onclick="vocabManager.toggleDrawer()"></div>
<div class="drawer" id="vocab-drawer">
    <div class="drawer-header">
        <div class="drawer-title">My Vocabulary</div>
        <button class="drawer-close" onclick="vocabManager.toggleDrawer()">‚úï</button>
    </div>
    <div class="drawer-content" id="drawer-list">
        <!-- Saved words go here -->
        <div style="text-align:center; color:var(--text-light); margin-top:40px;">No words saved yet.</div>
    </div>
    <div class="drawer-footer">
        <button class="btn-block" onclick="practiceManager.start()">üéì Practice Flashcards</button>
    </div>
</div>

<!-- Practice Modal -->
<div class="practice-modal" id="practice-modal">
    <div style="position:absolute; top:20px; right:20px;">
        <button class="icon-btn" style="font-size:2rem;" onclick="practiceManager.close()">‚úï</button>
    </div>
    <h2 style="margin-bottom:40px;">Flashcards</h2>
    <div class="flashcard" onclick="this.classList.toggle('flipped')">
        <div class="flashcard-inner">
            <div class="fc-front" id="fc-front">Click to flip</div>
            <div class="fc-back" id="fc-back">Translation</div>
        </div>
    </div>
    <div style="display:flex; gap:20px;">
        <button class="ui-btn" onclick="practiceManager.prev()">‚Üê Prev</button>
        <button class="ui-btn" onclick="practiceManager.next()">Next ‚Üí</button>
    </div>
    <div style="margin-top:20px; color:var(--text-light);" id="fc-counter">0 / 0</div>
</div>


<!-- Main App -->
<div id="progress-container"><div id="progress-bar"></div></div>

<div class="hero" id="hero">
    <div class="hero-content" id="hero-content">
        <!-- Skeleton -->
        <div class="skeleton" style="height:30px; width:100px; margin:0 auto 20px;"></div>
        <div class="skeleton" style="height:60px; width:60%; margin:0 auto;"></div>
    </div>
</div>

<div class="layout">
    <main id="app">
        <div class="block"><div class="skeleton" style="height:20px; width:40%; margin-bottom:10px;"></div><div class="skeleton" style="height:100px;"></div></div>
    </main>
    <aside class="sidebar-nav">
        <div class="q-item" style="padding:20px;">
            <h4 style="margin:0 0 15px 0; color:var(--text-light); text-transform:uppercase; font-size:0.8rem; letter-spacing:1px;">Lesson Plan</h4>
            <nav id="nav-list" style="display:flex; flex-direction:column; gap:10px;"></nav>
        </div>
    </aside>
</div>

<script>
    // --- 1. MOCK DICTIONARY ---
    const MOCK_DICTIONARY = {
        "voting": "–≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ",
        "countries": "—Å—Ç—Ä–∞–Ω—ã",
        "prison": "—Ç—é—Ä—å–º–∞",
        "politicians": "–ø–æ–ª–∏—Ç–∏–∫–∏",
        "marriage": "–±—Ä–∞–∫",
        "patient": "—Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π",
        "military": "–≤–æ–µ–Ω–Ω—ã–π",
        "army": "–∞—Ä–º–∏—è",
        "responsible": "–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π",
        "crime": "–ø—Ä–µ—Å—Ç—É–ø–ª–µ–Ω–∏–µ",
        "illegal": "–Ω–µ–∑–∞–∫–æ–Ω–Ω–æ",
        "driving": "–≤–æ–∂–¥–µ–Ω–∏–µ",
        "permission": "—Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ",
        "murder": "—É–±–∏–π—Å—Ç–≤–æ",
        "sweets": "—Å–ª–∞–¥–æ—Å—Ç–∏",
        "strict": "—Å—Ç—Ä–æ–≥–∏–π",
        "banned": "–∑–∞–ø—Ä–µ—â–µ–Ω–æ",
        "law": "–∑–∞–∫–æ–Ω",
        "affect": "–≤–ª–∏—è—Ç—å",
        "government": "–ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–æ",
        "society": "–æ–±—â–µ—Å—Ç–≤–æ",
        "adult": "–≤–∑—Ä–æ—Å–ª—ã–π"
    };

    // --- 2. APP STATE & UTILS ---
    const lessonId = window.location.pathname.split('/').pop().replace('.html', '') || '263';
    let savedWords = JSON.parse(localStorage.getItem(`lesson_${lessonId}_words`)) || [];

    function speak(text) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-GB'; u.rate = 0.9;
        window.speechSynthesis.speak(u);
    }

    // --- 3. VOCABULARY MANAGER ---
    const vocabManager = {
        init() {
            this.updateCounter();
            this.renderDrawer();
        },
        toggleWord(word) {
            // Clean word for check
            const clean = word.toLowerCase().replace(/[^a-z]/g, '');
            const idx = savedWords.findIndex(w => w.id === clean);
            
            if (idx > -1) {
                savedWords.splice(idx, 1);
            } else {
                const trans = MOCK_DICTIONARY[clean] || "Translation unavailable";
                savedWords.push({ id: clean, original: word, translation: trans });
            }
            
            this.save();
            this.renderDrawer();
            this.updateCounter();
            
            // Update UI elements (tooltips, cards)
            document.querySelectorAll(`.word[data-word="${clean}"]`).forEach(el => {
                el.classList.toggle('saved', idx === -1);
            });
            // Update tooltip button state if open
            const ttBtn = document.getElementById('tt-save-btn');
            if (ttBtn) {
                const isSaved = savedWords.some(w => w.id === clean);
                ttBtn.classList.toggle('is-saved', isSaved);
                ttBtn.innerText = isSaved ? '‚úì Saved' : '+ Save';
            }
        },
        isSaved(word) {
            const clean = word.toLowerCase().replace(/[^a-z]/g, '');
            return savedWords.some(w => w.id === clean);
        },
        remove(id) {
            savedWords = savedWords.filter(w => w.id !== id);
            this.save();
            this.renderDrawer();
            this.updateCounter();
            document.querySelectorAll(`.word[data-word="${id}"]`).forEach(el => el.classList.remove('saved'));
        },
        save() {
            localStorage.setItem(`lesson_${lessonId}_words`, JSON.stringify(savedWords));
        },
        updateCounter() {
            document.getElementById('saved-count').innerText = savedWords.length;
        },
        renderDrawer() {
            const container = document.getElementById('drawer-list');
            if (savedWords.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:var(--text-light); margin-top:40px;">No words saved yet. <br>Click words in text to save them.</div>';
                return;
            }
            container.innerHTML = savedWords.map(w => `
                <div class="saved-item">
                    <div class="saved-info">
                        <div>${w.original}</div>
                        <div>${w.translation}</div>
                    </div>
                    <div class="saved-actions">
                        <button class="icon-btn" onclick="speak('${w.original}')">üîä</button>
                        <button class="icon-btn" style="color:var(--error)" onclick="vocabManager.remove('${w.id}')">‚úï</button>
                    </div>
                </div>
            `).join('');
        },
        toggleDrawer() {
            document.querySelector('.drawer').classList.toggle('open');
            document.querySelector('.drawer-overlay').classList.toggle('open');
        }
    };

    // --- 4. TOOLTIP MANAGER ---
    const tooltipManager = {
        el: document.getElementById('tooltip'),
        currentWord: null,
        
        show(target, word) {
            const clean = word.toLowerCase().replace(/[^a-z]/g, '');
            this.currentWord = word;
            const trans = MOCK_DICTIONARY[clean] || "Translation unavailable";
            const isSaved = vocabManager.isSaved(clean);

            // Content
            this.el.querySelector('.tt-word').innerText = word;
            this.el.querySelector('.tt-trans').innerText = trans;
            const btn = this.el.querySelector('#tt-save-btn');
            btn.classList.toggle('is-saved', isSaved);
            btn.innerText = isSaved ? '‚úì Saved' : '+ Save';

            // Position
            const rect = target.getBoundingClientRect();
            const ttRect = this.el.getBoundingClientRect(); // need dimensions
            
            let top = rect.top + window.scrollY - this.el.offsetHeight - 10;
            let left = rect.left + window.scrollX + (rect.width / 2) - (150 / 2); // center approx

            // Boundary check
            if (left < 10) left = 10;
            if (left + 160 > window.innerWidth) left = window.innerWidth - 170;

            this.el.style.top = `${top}px`;
            this.el.style.left = `${left}px`;
            this.el.classList.add('visible');
        },
        hide() {
            this.el.classList.remove('visible');
        },
        toggleSave() {
            if(this.currentWord) vocabManager.toggleWord(this.currentWord);
        },
        playCurrent() {
            if(this.currentWord) speak(this.currentWord);
        }
    };

    // --- 5. TEXT PROCESSING ---
    function processText(text) {
        // Split by spaces but keep punctuation to reconstruct
        // Logic: Find words, wrap in span, keep everything else
        // Simple regex splitter:
        return text.split(/(\s+|[.,!?;:()"])/).map(part => {
            if (part.trim().length === 0 || !/[a-zA-Z]/.test(part)) return part;
            
            // It's a word
            const clean = part.toLowerCase().replace(/[^a-z]/g, '');
            const isSaved = vocabManager.isSaved(clean) ? 'saved' : '';
            
            return `<span class="word ${isSaved}" data-word="${clean}" 
                onmouseenter="handleWordHover(this)" 
                onclick="handleWordClick(this)">${part}</span>`;
        }).join('');
    }

    let hoverTimeout;
    window.handleWordHover = function(el) {
        clearTimeout(hoverTimeout);
        const word = el.innerText;
        tooltipManager.show(el, word);
    };
    
    // Close tooltip when clicking elsewhere or scrolling
    window.addEventListener('scroll', () => tooltipManager.hide());
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.word') && !e.target.closest('#tooltip')) {
            tooltipManager.hide();
        }
    });

    window.handleWordClick = function(el) {
        const word = el.innerText;
        speak(word);
        tooltipManager.show(el, word); // Ensure it stays/shows
    };

    // --- 6. PRACTICE MODE ---
    const practiceManager = {
        modal: document.getElementById('practice-modal'),
        index: 0,
        list: [],
        
        start() {
            if(savedWords.length === 0) return alert("Save some words first!");
            this.list = [...savedWords].sort(() => Math.random() - 0.5); // Shuffle
            this.index = 0;
            this.updateCard();
            this.modal.classList.add('open');
            vocabManager.toggleDrawer(); // close drawer
        },
        close() {
            this.modal.classList.remove('open');
        },
        updateCard() {
            const item = this.list[this.index];
            document.getElementById('fc-front').innerText = item.original;
            document.getElementById('fc-back').innerText = item.translation;
            document.querySelector('.flashcard').classList.remove('flipped');
            document.getElementById('fc-counter').innerText = `${this.index + 1} / ${this.list.length}`;
        },
        next() {
            this.index = (this.index + 1) % this.list.length;
            this.updateCard();
        },
        prev() {
            this.index = (this.index - 1 + this.list.length) % this.list.length;
            this.updateCard();
        }
    };


    // --- 7. RENDER ENGINE (From previous version, updated) ---
    
    // Theme logic
    function toggleTheme() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        document.body.setAttribute('data-theme', isDark ? 'light' : 'dark');
    }

    // Fetch & Render
    fetch(`../data/${lessonId}.json`)
        .then(r => r.ok ? r.json() : Promise.reject('JSON missing'))
        .then(data => {
            renderLesson(data);
            vocabManager.init();
        })
        .catch(err => {
            document.getElementById('app').innerHTML = `<div style="padding:40px; text-align:center; color:red">Error: ${err}<br>Make sure ../data/${lessonId}.json exists</div>`;
        });

    function renderLesson(data) {
        document.title = data.title;
        if (data.colors) document.documentElement.style.setProperty('--accent', data.colors[0]);
        
        // Hero
        const heroContent = document.getElementById('hero-content');
        heroContent.innerHTML = `
            <span class="hero-tag">LESSON ${data.id}</span>
            <h1 class="lesson-title">${data.title}</h1>
            <div class="lesson-subtitle">${data.subtitle || ''}</div>
        `;

        // Blocks
        let html = '';
        let navHtml = '';
        
        data.content.forEach((item, i) => {
            const id = `blk-${i}`;
            if (item.title) {
                navHtml += `<a href="#" onclick="document.getElementById('${id}').scrollIntoView({behavior:'smooth'}); return false;" style="text-decoration:none; color:var(--text); font-size:0.9rem;">${item.title}</a>`;
            }
            
            html += `<div id="${id}" class="block">`;
            
            if (item.type === 'block') {
                html += `
                    <div class="block-header">
                        <h3 class="block-title">${item.title || ''}</h3>
                        <button class="btn-audio" onclick="readBlock(this)">
                            <div class="pulse-dot"></div> Listen
                        </button>
                    </div>
                    <div class="reading-text">${processText(item.text)}</div>
                `;
            } else if (item.type === 'fact') {
                html += `
                    <div style="background:var(--surface); padding:20px; border-left:4px solid var(--accent); border-radius:10px; box-shadow:var(--shadow);">
                        <div style="font-weight:800; color:var(--accent); margin-bottom:10px;">DID YOU KNOW?</div>
                        <div class="reading-text" style="font-style:italic;">${processText(item.text)}</div>
                    </div>
                `;
            } else if (item.type === 'vocab') {
                html += `<h3 class="block-title">Vocabulary</h3><div class="grid">`;
                item.items.forEach(w => {
                    const isSaved = vocabManager.isSaved(w.en) ? 'saved' : '';
                    html += `
                        <div class="v-item" onclick="speak('${w.en}')">
                            <div class="v-bookmark ${isSaved}" onclick="event.stopPropagation(); vocabManager.toggleWord('${w.en}')">‚òÖ</div>
                            <span class="en">${w.en}</span>
                            <span class="ru">${w.ru}</span>
                        </div>
                    `;
                });
                html += `</div>`;
            } else if (item.type === 'quiz') {
                const opts = item.options.map((o, idx) => 
                    `<button class="opt-btn" onclick="checkQuiz(this, ${idx}, ${item.answer}, '${(item.feedback||'').replace(/'/g,"\\'")}')">${o}</button>`
                ).join('');
                html += `
                    <div class="q-item">
                        <h3 style="margin-top:0">${item.question}</h3>
                        <div class="opts">${opts}</div>
                        <div class="fb"></div>
                    </div>
                `;
            }
            
            html += `</div>`;
        });

        document.getElementById('app').innerHTML = html;
        document.getElementById('nav-list').innerHTML = navHtml;

        // Animate reveal
        setTimeout(() => {
            document.querySelectorAll('.block').forEach(b => b.classList.add('reveal'));
        }, 100);
    }

    // --- HELPERS (Audio, Quiz) ---
    function readBlock(btn) {
        if(btn.classList.contains('playing')) {
            window.speechSynthesis.cancel();
            btn.classList.remove('playing');
            return;
        }
        const txt = btn.closest('.block').querySelector('.reading-text').innerText;
        btn.classList.add('playing');
        speak(txt);
        // Simple timeout reset as speech API event handling can be flaky across browsers
        setTimeout(() => btn.classList.remove('playing'), txt.length * 60); 
    }

    window.checkQuiz = function(btn, idx, correct, fbTxt) {
        const parent = btn.closest('.q-item');
        const fb = parent.querySelector('.fb');
        parent.querySelectorAll('.opt-btn').forEach(b => b.disabled = true);
        
        if (idx === correct) {
            btn.classList.add('good');
            fb.innerHTML = `<b style="color:var(--success)">Correct!</b> ${fbTxt}`;
        } else {
            btn.classList.add('bad');
            parent.querySelectorAll('.opt-btn')[correct].classList.add('good');
            fb.innerHTML = `<b style="color:var(--error)">Incorrect.</b> ${fbTxt}`;
        }
        fb.style.display = 'block';
    }

    // Scroll Progress
    window.addEventListener('scroll', () => {
        const s = window.scrollY / (document.documentElement.scrollHeight - window.innerHeight);
        document.getElementById('progress-bar').style.width = (s * 100) + '%';
    });

</script>
</body>
</html>
