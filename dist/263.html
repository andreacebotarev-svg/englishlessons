<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta name="theme-color" content="#0f0f12">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Loading Lesson...</title>
    
    <style>
/* ================================================================
   1. CSS VARIABLES
   ================================================================ */
:root {
    /* ===== COLORS ===== */
    /* Background */
    --bg-primary: #0f0f12;
    --bg-secondary: #1C1C1E;
    --bg-tertiary: #2C2C2E;
    
    /* Text */
    --text-primary: #E5E5EA;
    --text-secondary: #8E8E93;
    --text-muted: #636366;
    
    /* Accent colors (–±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –∏–∑ JSON) */
    --accent-1: #00838F;
    --accent-2: #E0F7FA;
    
    /* Semantic colors */
    --success: #34C759;
    --success-bg: rgba(52, 199, 89, 0.15);
    --error: #FF3B30;
    --error-bg: rgba(255, 59, 48, 0.15);
    --warning: #FF9500;
    --info: #0A84FF;
    
    /* ===== SPACING ===== */
    --space-xs: 0.25rem;
    --space-sm: 0.5rem;
    --space-md: 1rem;
    --space-lg: 1.5rem;
    --space-xl: 2rem;
    --space-xxl: 3rem;
    
    /* ===== TYPOGRAPHY ===== */
    --font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", 
                   "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    --font-size-xs: 0.75rem;
    --font-size-sm: 0.875rem;
    --font-size-base: 1rem;
    --font-size-lg: 1.125rem;
    --font-size-xl: 1.25rem;
    --font-size-2xl: 1.5rem;
    --font-size-3xl: 2rem;
    
    --font-weight-normal: 400;
    --font-weight-medium: 500;
    --font-weight-semibold: 600;
    --font-weight-bold: 700;
    
    --line-height-tight: 1.2;
    --line-height-normal: 1.5;
    --line-height-relaxed: 1.75;
    
    /* ===== BORDERS ===== */
    --border-radius-sm: 8px;
    --border-radius-md: 12px;
    --border-radius-lg: 16px;
    --border-radius-xl: 20px;
    --border-radius-full: 9999px;
    
    /* ===== SHADOWS ===== */
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.3);
    --shadow-lg: 0 10px 20px rgba(0, 0, 0, 0.4);
    --shadow-xl: 0 20px 40px rgba(0, 0, 0, 0.5);
    
    /* ===== TRANSITIONS ===== */
    --transition-fast: 0.15s ease;
    --transition-base: 0.3s ease;
    --transition-slow: 0.5s ease;
    
    /* ===== Z-INDEX ===== */
    --z-base: 1;
    --z-dropdown: 100;
    --z-sticky: 200;
    --z-sidebar: 300;
    --z-modal: 400;
    --z-loader: 500;
}

/* ================================================================
   2. RESET & BASE STYLES
   ================================================================ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    text-rendering: optimizeLegibility;
}

body {
    font-family: var(--font-family);
    font-size: var(--font-size-base);
    line-height: var(--line-height-normal);
    color: var(--text-primary);
    background: var(--bg-primary);
    overflow-x: hidden;
    min-height: 100vh;
}

*:focus:not(:focus-visible) {
    outline: none;
}

*:focus-visible {
    outline: 2px solid var(--accent-1);
    outline-offset: 2px;
}

h1, h2, h3, h4, h5, h6 {
    line-height: var(--line-height-tight);
    font-weight: var(--font-weight-bold);
}

p {
    margin-bottom: var(--space-md);
}

a {
    color: var(--accent-1);
    text-decoration: none;
    transition: color var(--transition-fast);
}

a:hover {
    color: var(--accent-2);
}

button {
    font-family: inherit;
    cursor: pointer;
    border: none;
    background: none;
    -webkit-tap-highlight-color: transparent;
}

::-webkit-scrollbar {
    width: 6px;
    height: 6px;
}

::-webkit-scrollbar-track {
    background: var(--bg-secondary);
}

::-webkit-scrollbar-thumb {
    background: var(--text-muted);
    border-radius: var(--border-radius-full);
}

::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

/* ================================================================
   3. LAYOUT
   ================================================================ */
#app {
    opacity: 0;
    transition: opacity var(--transition-slow);
}

#app.loaded {
    opacity: 1;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 var(--space-md);
}

.main-content {
    padding-bottom: 80px;
}

/* ================================================================
   4. HEADER
   ================================================================ */
header {
    background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
    padding: var(--space-xl) var(--space-md);
    text-align: center;
    position: relative;
    overflow: hidden;
}

header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: headerPulse 15s ease-in-out infinite;
}

@keyframes headerPulse {
    0%, 100% { transform: translate(0, 0) scale(1); }
    50% { transform: translate(5%, 5%) scale(1.1); }
}

.lesson-title {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: white;
    margin-bottom: var(--space-sm);
    text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    position: relative;
    z-index: 1;
}

.lesson-subtitle {
    font-size: var(--font-size-lg);
    color: rgba(255,255,255,0.9);
    font-weight: var(--font-weight-medium);
    position: relative;
    z-index: 1;
}

.lesson-meta {
    display: flex;
    gap: var(--space-sm);
    justify-content: center;
    margin-top: var(--space-md);
    position: relative;
    z-index: 1;
}

.badge {
    display: inline-flex;
    align-items: center;
    padding: var(--space-xs) var(--space-md);
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    color: white;
    border: 1px solid rgba(255,255,255,0.3);
}

/* ================================================================
   5. NAVIGATION TABS
   ================================================================ */
.nav-container {
    display: flex;
    gap: var(--space-sm);
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--bg-tertiary);
    overflow-x: auto;
    overflow-y: hidden;
    position: sticky;
    top: 0;
    z-index: var(--z-sticky);
    backdrop-filter: blur(10px);
    -webkit-overflow-scrolling: touch;
}

.nav-container::-webkit-scrollbar {
    display: none;
}

.nav-tab {
    flex-shrink: 0;
    padding: var(--space-sm) var(--space-lg);
    background: transparent;
    color: var(--text-secondary);
    border: 2px solid transparent;
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    transition: all var(--transition-base);
    cursor: pointer;
    white-space: nowrap;
}

.nav-tab:hover {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}

.nav-tab.active {
    background: var(--accent-1);
    color: white;
    border-color: var(--accent-1);
    box-shadow: 0 4px 12px rgba(0, 131, 143, 0.3);
}

.nav-tab:active {
    transform: scale(0.96);
}

/* ================================================================
   6. CONTENT SECTIONS
   ================================================================ */
.content-section {
    display: none;
    padding: var(--space-lg);
    animation: fadeInUp var(--transition-base);
}

.content-section.active {
    display: block;
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ================================================================
   7. READING SECTION
   ================================================================ */
.reading-block {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
    border-left: 4px solid var(--accent-1);
}

.reading-block[data-type="fact"] {
    background: linear-gradient(135deg, rgba(0,131,143,0.1), rgba(224,247,250,0.05));
    border-left-color: var(--accent-2);
}

.reading-block h3 {
    font-size: var(--font-size-xl);
    margin-bottom: var(--space-md);
    color: var(--accent-1);
}

.reading-text {
    font-size: var(--font-size-lg);
    line-height: var(--line-height-relaxed);
    color: var(--text-primary);
}

.reading-text .word {
    display: inline;
    padding: 2px 4px;
    border-radius: 4px;
    cursor: pointer;
    transition: all var(--transition-fast);
    position: relative;
}

.reading-text .word.clickable {
    color: var(--accent-1);
    font-weight: var(--font-weight-semibold);
}

.reading-text .word.clickable:hover {
    background: rgba(0,131,143,0.15);
    transform: translateY(-1px);
}

.reading-text .word.clickable:active {
    transform: translateY(0);
}

.listen-btn {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm) var(--space-lg);
    background: var(--accent-1);
    color: white;
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    margin-bottom: var(--space-md);
    transition: all var(--transition-base);
}

.listen-btn:hover {
    background: var(--accent-2);
    color: #333;
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.listen-btn:active {
    transform: translateY(0);
}

.listen-btn.playing {
    background: var(--error);
    animation: pulse 1s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* ================================================================
   8. VOCABULARY SECTION
   ================================================================ */
.vocab-controls {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-lg);
    justify-content: center;
}

.mode-btn {
    padding: var(--space-sm) var(--space-xl);
    background: var(--bg-secondary);
    color: var(--text-secondary);
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    transition: all var(--transition-base);
}

.mode-btn.active {
    background: var(--accent-1);
    color: white;
}

.vocab-mode {
    display: none;
}

.vocab-mode.active {
    display: block;
}

.vocab-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--space-lg);
}

.vocab-card {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: var(--space-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    border: 2px solid transparent;
}

.vocab-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-lg);
    border-color: var(--accent-1);
}

.word-en {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--accent-1);
    margin-bottom: var(--space-xs);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
}

.phonetic {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    font-weight: var(--font-weight-normal);
}

.word-ru {
    font-size: var(--font-size-lg);
    color: var(--text-secondary);
    margin-bottom: var(--space-md);
}

.word-example {
    font-size: var(--font-size-base);
    font-style: italic;
    color: var(--text-muted);
    margin-bottom: var(--space-md);
    padding-left: var(--space-md);
    border-left: 2px solid var(--bg-tertiary);
}

.word-meta {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

.pos {
    display: inline-block;
    padding: 2px var(--space-sm);
    background: var(--bg-tertiary);
    border-radius: var(--border-radius-sm);
    font-size: var(--font-size-xs);
    color: var(--text-secondary);
    text-transform: uppercase;
}

.save-btn {
    width: 100%;
    padding: var(--space-sm);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    transition: all var(--transition-base);
}

.save-btn:hover {
    background: var(--success);
    color: white;
}

.save-btn.saved {
    background: var(--success);
    color: white;
    pointer-events: none;
}

.flashcard {
    display: none;
    width: 100%;
    max-width: 500px;
    height: 350px;
    margin: 0 auto var(--space-xl);
    perspective: 1000px;
}

.flashcard.active {
    display: block;
}

.flashcard-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.6s;
    transform-style: preserve-3d;
    cursor: pointer;
}

.flashcard.flipped .flashcard-inner {
    transform: rotateY(180deg);
}

.flashcard-front,
.flashcard-back {
    position: absolute;
    width: 100%;
    height: 100%;
    backface-visibility: hidden;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--space-xl);
    background: var(--bg-secondary);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-xl);
}

.flashcard-back {
    transform: rotateY(180deg);
}

.flashcard-word {
    font-size: var(--font-size-3xl);
    font-weight: var(--font-weight-bold);
    color: var(--accent-1);
    text-align: center;
}

.flashcard-hint {
    margin-top: var(--space-md);
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
}

.flashcard-translation {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    text-align: center;
    margin-bottom: var(--space-md);
}

.flashcard-example {
    font-size: var(--font-size-base);
    font-style: italic;
    color: var(--text-secondary);
    text-align: center;
}

.flashcard-controls {
    display: flex;
    gap: var(--space-md);
    justify-content: center;
    align-items: center;
}

.flashcard-controls button {
    padding: var(--space-md) var(--space-xl);
    background: var(--accent-1);
    color: white;
    border-radius: var(--border-radius-md);
    font-weight: var(--font-weight-semibold);
    transition: all var(--transition-base);
}

.flashcard-controls button:hover {
    background: var(--accent-2);
    color: #333;
    transform: scale(1.05);
}

#cardCounter {
    font-size: var(--font-size-lg);
    color: var(--text-secondary);
    font-weight: var(--font-weight-medium);
}

.phrases-section {
    margin-top: var(--space-xxl);
}

.phrases-section h3 {
    font-size: var(--font-size-xl);
    margin-bottom: var(--space-lg);
    color: var(--accent-1);
}

.phrase-item {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-md);
    padding: var(--space-md);
    margin-bottom: var(--space-sm);
    cursor: pointer;
    transition: all var(--transition-base);
}

.phrase-item:hover {
    background: var(--bg-tertiary);
    transform: translateX(5px);
}

.phrase-en {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--accent-1);
    margin-bottom: var(--space-xs);
}

.phrase-ru {
    font-size: var(--font-size-base);
    color: var(--text-secondary);
}

.phrase-context {
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    margin-top: var(--space-xs);
}

/* ================================================================
   9. QUIZ SECTION
   ================================================================ */
.quiz-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-xl);
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
}

.quiz-header h2 {
    font-size: var(--font-size-2xl);
    color: var(--accent-1);
}

.quiz-score {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    color: var(--text-primary);
}

.quiz-question {
    background: var(--bg-secondary);
    border-radius: var(--border-radius-lg);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
}

.question-number {
    font-size: var(--font-size-sm);
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
}

.question-text {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin-bottom: var(--space-lg);
    line-height: var(--line-height-relaxed);
}

.question-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.quiz-option {
    width: 100%;
    padding: var(--space-lg);
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 2px solid transparent;
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
    text-align: left;
    cursor: pointer;
    transition: all var(--transition-base);
}

.quiz-option:hover:not(:disabled) {
    background: var(--bg-primary);
    border-color: var(--accent-1);
    transform: translateX(5px);
}

.quiz-option:active:not(:disabled) {
    transform: scale(0.98);
}

.quiz-option:disabled {
    cursor: not-allowed;
}

.quiz-option.correct {
    background: var(--success-bg);
    border-color: var(--success);
    color: var(--success);
    animation: correctAnswer 0.5s ease;
}

.quiz-option.incorrect {
    background: var(--error-bg);
    border-color: var(--error);
    color: var(--error);
    animation: shake 0.5s ease;
}

@keyframes correctAnswer {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
}

.question-feedback {
    display: none;
    margin-top: var(--space-md);
    padding: var(--space-md);
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    animation: fadeIn 0.3s ease;
}

.question-feedback.show {
    display: block;
}

.feedback-correct {
    background: var(--success-bg);
    color: var(--success);
    border-left: 4px solid var(--success);
}

.feedback-incorrect {
    background: var(--error-bg);
    color: var(--error);
    border-left: 4px solid var(--error);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ================================================================
   10. SIDEBAR (MY WORDS)
   ================================================================ */
.sidebar {
    position: fixed;
    top: 0;
    right: -320px;
    width: 320px;
    height: 100vh;
    background: var(--bg-secondary);
    box-shadow: var(--shadow-xl);
    transition: right var(--transition-base);
    z-index: var(--z-sidebar);
    display: flex;
    flex-direction: column;
}

.sidebar.open {
    right: 0;
}

.sidebar-toggle {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: var(--space-sm) var(--space-lg);
    background: var(--accent-1);
    color: white;
    border-radius: var(--border-radius-full);
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-semibold);
    box-shadow: var(--shadow-md);
    z-index: var(--z-sidebar);
    transition: all var(--transition-base);
}

.sidebar-toggle:hover {
    background: var(--accent-2);
    color: #333;
    transform: scale(1.05);
}

.sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-xl) var(--space-lg);
}

.saved-words-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
}

.saved-word {
    background: var(--bg-tertiary);
    border-radius: var(--border-radius-md);
    padding: var(--space-md);
    position: relative;
}

.saved-word-en {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--accent-1);
    margin-bottom: var(--space-xs);
    cursor: pointer;
}

.saved-word-ru {
    font-size: var(--font-size-base);
    color: var(--text-secondary);
}

.remove-word-btn {
    position: absolute;
    top: var(--space-sm);
    right: var(--space-sm);
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--error);
    color: white;
    border-radius: 50%;
    font-size: var(--font-size-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
}

.remove-word-btn:hover {
    transform: scale(1.1);
    background: #ff1a1a;
}

.no-words {
    text-align: center;
    color: var(--text-secondary);
    font-size: var(--font-size-base);
    padding: var(--space-xl);
}

/* ================================================================
   11. LOADER
   ================================================================ */
.loader-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: var(--bg-primary);
    z-index: var(--z-loader);
    transition: opacity var(--transition-slow);
}

.loader-container.hidden {
    opacity: 0;
    pointer-events: none;
}

.loader {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(255,255,255,0.1);
    border-top-color: var(--accent-1);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loader-text {
    margin-top: var(--space-lg);
    font-size: var(--font-size-lg);
    color: var(--text-secondary);
    animation: pulse 2s ease-in-out infinite;
}

.error-container {
    text-align: center;
    padding: var(--space-xl);
}

.error-icon {
    font-size: 4rem;
    margin-bottom: var(--space-lg);
}

.error-container h2 {
    font-size: var(--font-size-2xl);
    color: var(--error);
    margin-bottom: var(--space-md);
}

.error-container p {
    font-size: var(--font-size-base);
    color: var(--text-secondary);
    margin-bottom: var(--space-xl);
}

.error-container button {
    padding: var(--space-md) var(--space-xl);
    background: var(--accent-1);
    color: white;
    border-radius: var(--border-radius-md);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-semibold);
    transition: all var(--transition-base);
}

.error-container button:hover {
    background: var(--accent-2);
    color: #333;
    transform: scale(1.05);
}

/* ================================================================
   12. UTILITY CLASSES
   ================================================================ */
.hidden { display: none !important; }
.block { display: block !important; }
.flex { display: flex !important; }
.inline-flex { display: inline-flex !important; }

.text-center { text-align: center !important; }
.text-left { text-align: left !important; }
.text-right { text-align: right !important; }

.text-primary { color: var(--text-primary) !important; }
.text-secondary { color: var(--text-secondary) !important; }
.text-muted { color: var(--text-muted) !important; }
.text-success { color: var(--success) !important; }
.text-error { color: var(--error) !important; }

.notification {
    position: fixed;
    bottom: -100px;
    left: 50%;
    transform: translateX(-50%);
    padding: var(--space-md) var(--space-xl);
    background: var(--bg-secondary);
    color: var(--text-primary);
    border-radius: var(--border-radius-full);
    box-shadow: var(--shadow-xl);
    z-index: var(--z-modal);
    transition: bottom var(--transition-base);
    font-size: var(--font-size-base);
    font-weight: var(--font-weight-medium);
}

.notification.show {
    bottom: 20px;
}

/* ================================================================
   13. RESPONSIVE DESIGN
   ================================================================ */
@media (max-width: 768px) {
    :root {
        --font-size-3xl: 1.75rem;
        --font-size-2xl: 1.25rem;
        --font-size-xl: 1.125rem;
    }
    
    header {
        padding: var(--space-lg) var(--space-md);
    }
    
    .lesson-title {
        font-size: var(--font-size-2xl);
    }
    
    .nav-tab {
        padding: var(--space-sm) var(--space-md);
        font-size: var(--font-size-sm);
    }
    
    .content-section {
        padding: var(--space-md);
    }
    
    .vocab-grid {
        grid-template-columns: 1fr;
    }
    
    .flashcard {
        height: 300px;
    }
    
    .quiz-option {
        padding: var(--space-md);
    }
    
    .sidebar {
        width: 100%;
        right: -100%;
    }
}

@media (max-width: 480px) {
    .quiz-header {
        flex-direction: column;
        gap: var(--space-md);
        text-align: center;
    }
    
    .flashcard {
        height: 250px;
    }
    
    .flashcard-word {
        font-size: var(--font-size-2xl);
    }
}
    </style>
</head>
<body>
    <!-- LOADER -->
    <div class="loader-container" id="loader">
        <div class="loader"></div>
        <div class="loader-text">Loading lesson...</div>
    </div>
    
    <!-- APP CONTAINER -->
    <div id="app"></div>
    
    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-content" id="sidebarContent">
            <h2 style="color: var(--accent-1); margin-bottom: var(--space-lg);">üíæ My Words</h2>
            <div class="saved-words-list" id="savedWordsList"></div>
        </div>
    </aside>
    
    <!-- SIDEBAR TOGGLE BUTTON -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        üíæ My Words (<span id="wordCount">0</span>)
    </button>
    
    <!-- NOTIFICATION -->
    <div class="notification" id="notification"></div>
    
    <script>
/* ================================================================
   1. GLOBAL VARIABLES
   ================================================================ */
let lessonData = null;
let myWords = [];
let quizScore = { correct: 0, total: 0 };
let currentCard = 0;
let currentVocabMode = 'list';

/* ================================================================
   2. LESSON ID DETECTION
   ================================================================ */
const lessonId = (() => {
    const pathname = window.location.pathname;
    const match = pathname.match(/(\d+)\.html$/);
    return match ? match[1] : null;
})();

if (!lessonId) {
    document.getElementById('loader').innerHTML = `
        <div class="error-container">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2>Error</h2>
            <p>Unable to determine lesson number from filename.</p>
            <button onclick="window.location.reload()">Reload Page</button>
        </div>
    `;
}

/* ================================================================
   3. JSON LOADING
   ================================================================ */
async function loadLesson() {
    if (!lessonId) return;
    
    try {
        const response = await fetch(`../data/${lessonId}.json`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        lessonData = await response.json();
        initLesson(lessonData);
        
    } catch (error) {
        console.error('Failed to load lesson:', error);
        showError(`Failed to load lesson ${lessonId}: ${error.message}`);
    }
}

function showError(message) {
    const loader = document.getElementById('loader');
    loader.innerHTML = `
        <div class="error-container">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2>Loading Error</h2>
            <p>${escapeJS(message)}</p>
            <button onclick="window.location.reload()">Try Again</button>
        </div>
    `;
}

/* ================================================================
   4. INIT LESSON
   ================================================================ */
function initLesson(data) {
    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.title = data.title;
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç–∞ –∏–∑ JSON
    if (data.colors && data.colors.length >= 2) {
        document.documentElement.style.setProperty('--accent-1', data.colors[0]);
        document.documentElement.style.setProperty('--accent-2', data.colors[1]);
    }
    
    // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ç–µ–º—É
    if (data.meta?.theme) {
        document.body.setAttribute('data-theme', data.meta.theme);
    }
    
    // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    const app = document.getElementById('app');
    app.innerHTML = buildInterface(data);
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ —Å–ª–æ–≤–∞
    loadMyWords();
    
    // –°–∫—Ä—ã—Ç—å loader
    setTimeout(() => {
        const loader = document.getElementById('loader');
        loader.classList.add('hidden');
        app.classList.add('loaded');
    }, 300);
}

/* ================================================================
   5. BUILD INTERFACE
   ================================================================ */
function buildInterface(data) {
    const hasGrammar = data.content.grammar && data.content.grammar.length > 0;
    
    return `
        <header>
            <h1 class="lesson-title">${escapeJS(data.title)}</h1>
            <p class="lesson-subtitle">${escapeJS(data.subtitle || '')}</p>
            <div class="lesson-meta">
                <span class="badge">${escapeJS(data.meta.level || 'B1')}</span>
                <span class="badge">${escapeJS(data.meta.duration || 30)} min</span>
            </div>
        </header>
        
        <nav class="nav-container">
            <button class="nav-tab active" onclick="switchTab('reading')">
                üìñ Reading
            </button>
            <button class="nav-tab" onclick="switchTab('vocabulary')">
                üìö Vocabulary
            </button>
            ${hasGrammar ? `
                <button class="nav-tab" onclick="switchTab('grammar')">
                    ‚úèÔ∏è Grammar
                </button>
            ` : ''}
            <button class="nav-tab" onclick="switchTab('quiz')">
                üéØ Quiz
            </button>
        </nav>
        
        <main class="main-content">
            <div id="reading" class="content-section active">
                ${renderReading(data.content.reading)}
            </div>
            
            <div id="vocabulary" class="content-section">
                ${renderVocabulary(data.content.vocabulary)}
            </div>
            
            ${hasGrammar ? `
                <div id="grammar" class="content-section">
                    ${renderGrammar(data.content.grammar)}
                </div>
            ` : ''}
            
            <div id="quiz" class="content-section">
                ${renderQuiz(data.quiz)}
            </div>
        </main>
    `;
}

/* ================================================================
   6. RENDER FUNCTIONS
   ================================================================ */

// READING SECTION
function renderReading(readingData) {
    if (!readingData || readingData.length === 0) {
        return '<p class="text-center text-secondary">No reading content available.</p>';
    }
    
    let html = '';
    
    readingData.forEach((block, index) => {
        const blockType = block.type || 'paragraph';
        const hasAudio = block.audio_paragraph === true;
        
        html += `
            <div class="reading-block" data-type="${blockType}">
                ${block.title ? `<h3>${escapeJS(block.title)}</h3>` : ''}
                
                ${hasAudio ? `
                    <button class="listen-btn" onclick="speakText('${escapeJS(block.text).replace(/'/g, "\\'")}', this)">
                        üîä Listen
                    </button>
                ` : ''}
                
                <div class="reading-text">
                    ${highlightWords(block.text, block.highlight || [])}
                </div>
            </div>
        `;
    });
    
    return html;
}

function highlightWords(text, wordsToHighlight) {
    if (!wordsToHighlight || wordsToHighlight.length === 0) {
        return escapeJS(text);
    }
    
    let result = escapeJS(text);
    
    wordsToHighlight.forEach(word => {
        const regex = new RegExp(`\\b(${word})\\b`, 'gi');
        result = result.replace(regex, '<span class="word clickable" onclick="speakWord(\'$1\')">$1</span>');
    });
    
    return result;
}

// VOCABULARY SECTION
function renderVocabulary(vocabData) {
    if (!vocabData || !vocabData.words || vocabData.words.length === 0) {
        return '<p class="text-center text-secondary">No vocabulary available.</p>';
    }
    
    const words = vocabData.words;
    const phrases = vocabData.phrases || [];
    
    return `
        <div class="vocab-controls">
            <button class="mode-btn active" onclick="switchVocabMode('list')">
                üìã List
            </button>
            <button class="mode-btn" onclick="switchVocabMode('flashcards')">
                üé¥ Flashcards
            </button>
        </div>
        
        <!-- LIST MODE -->
        <div id="vocabList" class="vocab-mode active">
            <div class="vocab-grid">
                ${words.map((word, index) => `
                    <div class="vocab-card" onclick="speakWord('${escapeJS(word.en).replace(/'/g, "\\'")}')">
                        <div class="word-en">
                            ${escapeJS(word.en)}
                            ${word.transcription ? `<span class="phonetic">${escapeJS(word.transcription)}</span>` : ''}
                        </div>
                        <div class="word-ru">${escapeJS(word.ru)}</div>
                        ${word.part_of_speech ? `
                            <div class="word-meta">
                                <span class="pos">${escapeJS(word.part_of_speech)}</span>
                            </div>
                        ` : ''}
                        ${word.example ? `<div class="word-example">"${escapeJS(word.example)}"</div>` : ''}
                        <button class="save-btn" onclick="event.stopPropagation(); saveWord('${escapeJS(word.en).replace(/'/g, "\\'")}', '${escapeJS(word.ru).replace(/'/g, "\\'")}', ${index})">
                            üíæ Save Word
                        </button>
                    </div>
                `).join('')}
            </div>
            
            ${phrases.length > 0 ? `
                <div class="phrases-section">
                    <h3>üìù Useful Phrases</h3>
                    ${phrases.map(phrase => `
                        <div class="phrase-item" onclick="speakText('${escapeJS(phrase.en).replace(/'/g, "\\'")}', this)">
                            <div class="phrase-en">${escapeJS(phrase.en)}</div>
                            <div class="phrase-ru">${escapeJS(phrase.ru)}</div>
                            ${phrase.context ? `<div class="phrase-context">Context: ${escapeJS(phrase.context)}</div>` : ''}
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        </div>
        
        <!-- FLASHCARDS MODE -->
        <div id="vocabFlashcards" class="vocab-mode">
            ${words.map((word, index) => `
                <div class="flashcard ${index === 0 ? 'active' : ''}" id="card-${index}" onclick="flipCard(${index})">
                    <div class="flashcard-inner">
                        <div class="flashcard-front">
                            <div class="flashcard-word">${escapeJS(word.en)}</div>
                            ${word.transcription ? `<div class="flashcard-hint">${escapeJS(word.transcription)}</div>` : ''}
                        </div>
                        <div class="flashcard-back">
                            <div class="flashcard-translation">${escapeJS(word.ru)}</div>
                            ${word.example ? `<div class="flashcard-example">"${escapeJS(word.example)}"</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('')}
            
            <div class="flashcard-controls">
                <button onclick="prevCard()">‚¨ÖÔ∏è Previous</button>
                <span id="cardCounter">1 / ${words.length}</span>
                <button onclick="nextCard()">Next ‚û°Ô∏è</button>
            </div>
        </div>
    `;
}

// GRAMMAR SECTION
function renderGrammar(grammarData) {
    if (!grammarData || grammarData.length === 0) {
        return '<p class="text-center text-secondary">No grammar content available.</p>';
    }
    
    return `
        <div class="grammar-container">
            <h2>‚úèÔ∏è Grammar Focus</h2>
            ${grammarData.map(rule => `
                <div class="grammar-rule">
                    ${rule.title ? `<h3>${escapeJS(rule.title)}</h3>` : ''}
                    ${rule.pattern ? `<div class="rule-pattern">${escapeJS(rule.pattern)}</div>` : ''}
                    ${rule.explanation ? `<div class="rule-description">${escapeJS(rule.explanation)}</div>` : ''}
                    
                    ${rule.examples ? `
                        <div class="examples-group">
                            <h4>Examples:</h4>
                            ${rule.examples.map(ex => `
                                <div class="example">${escapeJS(ex)}</div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${rule.mistakes ? `
                        <div class="mistakes-section">
                            <h3>‚ö†Ô∏è Common Mistakes</h3>
                            ${rule.mistakes.map(mistake => `
                                <div class="mistake-item">
                                    <div class="mistake-wrong">‚ùå ${escapeJS(mistake.wrong)}</div>
                                    <div class="mistake-correct">‚úÖ ${escapeJS(mistake.correct)}</div>
                                    ${mistake.why ? `<div class="mistake-why">${escapeJS(mistake.why)}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('')}
        </div>
    `;
}

// QUIZ SECTION
function renderQuiz(quizData) {
    if (!quizData || quizData.length === 0) {
        return '<p class="text-center text-secondary">No quiz available.</p>';
    }
    
    return `
        <div class="quiz-header">
            <h2>üéØ Test Your Knowledge</h2>
            <div class="quiz-score">
                Score: <span id="quizCorrect">0</span> / <span id="quizTotal">${quizData.length}</span>
            </div>
        </div>
        
        ${quizData.map((question, qIndex) => `
            <div class="quiz-question" id="question-${qIndex}">
                <div class="question-number">Question ${qIndex + 1} of ${quizData.length}</div>
                <div class="question-text">${escapeJS(question.q)}</div>
                
                <div class="question-options">
                    ${question.opts.map((option, optIndex) => `
                        <button class="quiz-option" 
                                onclick="checkAnswer(${qIndex}, ${optIndex}, ${question.correct})"
                                data-question="${qIndex}"
                                data-option="${optIndex}">
                            ${escapeJS(option)}
                        </button>
                    `).join('')}
                </div>
                
                <div class="question-feedback" id="feedback-${qIndex}"></div>
            </div>
        `).join('')}
        
        <div style="text-align: center; margin-top: var(--space-xl);">
            <button class="listen-btn" onclick="resetQuiz()">
                üîÑ Reset Quiz
            </button>
        </div>
    `;
}
/* ================================================================
   7. QUIZ LOGIC
   ================================================================ */
function checkAnswer(questionIndex, selectedOption, correctOption) {
    const questionDiv = document.getElementById(`question-${questionIndex}`);
    const buttons = questionDiv.querySelectorAll('.quiz-option');
    const feedback = document.getElementById(`feedback-${questionIndex}`);
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
    buttons.forEach(btn => btn.disabled = true);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
    const isCorrect = selectedOption === correctOption;
    
    // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç—ã
    buttons.forEach((btn, index) => {
        if (index === correctOption) {
            btn.classList.add('correct');
        }
        if (index === selectedOption && !isCorrect) {
            btn.classList.add('incorrect');
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç
    if (isCorrect) {
        quizScore.correct++;
        vibrate(200);
    } else {
        vibrate([100, 50, 100]);
    }
    
    quizScore.total++;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—á—ë—Ç–∞
    document.getElementById('quizCorrect').textContent = quizScore.correct;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º feedback
    const quizData = lessonData.quiz[questionIndex];
    feedback.innerHTML = `
        <div class="feedback-${isCorrect ? 'correct' : 'incorrect'}">
            ${isCorrect ? '‚úÖ' : '‚ùå'} ${escapeJS(quizData.fb || (isCorrect ? 'Correct!' : 'Incorrect.'))}
        </div>
    `;
    feedback.classList.add('show');
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É
    setTimeout(() => {
        const nextQuestion = document.getElementById(`question-${questionIndex + 1}`);
        if (nextQuestion) {
            nextQuestion.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }, 1500);
}

function resetQuiz() {
    quizScore = { correct: 0, total: 0 };
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
    document.querySelectorAll('.quiz-question').forEach(questionDiv => {
        const buttons = questionDiv.querySelectorAll('.quiz-option');
        buttons.forEach(btn => {
            btn.disabled = false;
            btn.classList.remove('correct', 'incorrect');
        });
        
        const feedback = questionDiv.querySelector('.question-feedback');
        if (feedback) {
            feedback.classList.remove('show');
            feedback.innerHTML = '';
        }
    });
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç
    document.getElementById('quizCorrect').textContent = '0';
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –Ω–∞—á–∞–ª—É
    document.getElementById('question-0').scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    showNotification('Quiz reset! Good luck! üçÄ');
}

/* ================================================================
   8. TEXT-TO-SPEECH (TTS)
   ================================================================ */
function speakWord(word) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
    }
    
    const cleanWord = word.toLowerCase().trim();
    
    // –ü—Ä–æ–±—É–µ–º Google TTS API (—Ä–∞–±–æ—Ç–∞–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è meta referrer)
    const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&tl=en&client=tw-ob&q=${encodeURIComponent(cleanWord)}`);
    
    audio.play().catch(err => {
        console.warn('Google TTS failed, using Web Speech API fallback:', err);
        speakWithBrowserAPI(cleanWord);
    });
    
    vibrate(50);
}

function speakText(text, button) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
    }
    
    // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ "playing", –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
    if (button && button.classList.contains('playing')) {
        button.classList.remove('playing');
        button.innerHTML = 'üîä Listen';
        return;
    }
    
    const cleanText = text.trim();
    
    // –ü—Ä–æ–±—É–µ–º Google TTS API
    const audio = new Audio(`https://translate.google.com/translate_tts?ie=UTF-8&tl=en&client=tw-ob&q=${encodeURIComponent(cleanText)}`);
    
    if (button) {
        button.classList.add('playing');
        button.innerHTML = '‚è∏Ô∏è Stop';
    }
    
    audio.addEventListener('ended', () => {
        if (button) {
            button.classList.remove('playing');
            button.innerHTML = 'üîä Listen';
        }
    });
    
    audio.addEventListener('error', () => {
        console.warn('Google TTS failed, using Web Speech API fallback');
        speakWithBrowserAPI(cleanText, button);
    });
    
    audio.play();
    vibrate(50);
}

function speakWithBrowserAPI(text, button) {
    if (!window.speechSynthesis) {
        showNotification('‚ö†Ô∏è Text-to-speech not supported in this browser');
        return;
    }
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.9;
    utterance.pitch = 1;
    
    utterance.onend = () => {
        if (button) {
            button.classList.remove('playing');
            button.innerHTML = 'üîä Listen';
        }
    };
    
    utterance.onerror = (e) => {
        console.error('Speech synthesis error:', e);
        if (button) {
            button.classList.remove('playing');
            button.innerHTML = 'üîä Listen';
        }
        showNotification('‚ö†Ô∏è Speech synthesis failed');
    };
    
    window.speechSynthesis.speak(utterance);
}

/* ================================================================
   9. MY WORDS (LocalStorage)
   ================================================================ */
function saveWord(en, ru, cardIndex) {
    const word = { en, ru };
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ª–∏ —É–∂–µ
    const exists = myWords.some(w => w.en.toLowerCase() === en.toLowerCase());
    
    if (exists) {
        showNotification('‚ö†Ô∏è Word already saved!');
        return;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª–æ–≤–æ
    myWords.push(word);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ LocalStorage
    try {
        localStorage.setItem(`lesson_${lessonId}_words`, JSON.stringify(myWords));
    } catch (e) {
        console.error('Failed to save to localStorage:', e);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    updateSavedWordsUI();
    
    // –ü–æ–º–µ—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∫–∞–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—É—é
    const saveButtons = document.querySelectorAll('.save-btn');
    if (saveButtons[cardIndex]) {
        saveButtons[cardIndex].classList.add('saved');
        saveButtons[cardIndex].innerHTML = '‚úÖ Saved';
    }
    
    showNotification(`üíæ "${en}" saved!`);
    vibrate(100);
}

function loadMyWords() {
    try {
        const saved = localStorage.getItem(`lesson_${lessonId}_words`);
        if (saved) {
            myWords = JSON.parse(saved);
        }
    } catch (e) {
        console.error('Failed to load from localStorage:', e);
        myWords = [];
    }
    
    updateSavedWordsUI();
}

function removeWord(en) {
    myWords = myWords.filter(w => w.en.toLowerCase() !== en.toLowerCase());
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ LocalStorage
    try {
        localStorage.setItem(`lesson_${lessonId}_words`, JSON.stringify(myWords));
    } catch (e) {
        console.error('Failed to save to localStorage:', e);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º UI
    updateSavedWordsUI();
    
    // –°–Ω–∏–º–∞–µ–º –æ—Ç–º–µ—Ç–∫—É "saved" —Å –∫–Ω–æ–ø–∫–∏
    const saveButtons = document.querySelectorAll('.save-btn');
    saveButtons.forEach(btn => {
        if (btn.textContent.includes('Saved') && btn.onclick.toString().includes(en)) {
            btn.classList.remove('saved');
            btn.innerHTML = 'üíæ Save Word';
        }
    });
    
    showNotification(`üóëÔ∏è "${en}" removed`);
    vibrate(50);
}

function updateSavedWordsUI() {
    const list = document.getElementById('savedWordsList');
    const counter = document.getElementById('wordCount');
    
    if (!list) return;
    
    counter.textContent = myWords.length;
    
    if (myWords.length === 0) {
        list.innerHTML = '<div class="no-words">No saved words yet.<br>Start saving words from the Vocabulary section! üìö</div>';
        return;
    }
    
    list.innerHTML = myWords.map(word => `
        <div class="saved-word">
            <div class="saved-word-en" onclick="speakWord('${escapeJS(word.en).replace(/'/g, "\\'")}')">
                ${escapeJS(word.en)}
            </div>
            <div class="saved-word-ru">${escapeJS(word.ru)}</div>
            <button class="remove-word-btn" onclick="removeWord('${escapeJS(word.en).replace(/'/g, "\\'")}')">
                ‚úï
            </button>
        </div>
    `).join('');
}

/* ================================================================
   10. NAVIGATION (–ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤)
   ================================================================ */
function switchTab(tabName) {
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º TTS –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–∞–±–∞
    if (window.speechSynthesis) {
        window.speechSynthesis.cancel();
    }
    
    // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–ª–∞—Å—Å—ã
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.content-section').forEach(section => section.classList.remove('active'));
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∞–±—É
    event.target.classList.add('active');
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å–µ–∫—Ü–∏—é
    const section = document.getElementById(tabName);
    if (section) {
        section.classList.add('active');
    }
    
    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –Ω–∞–≤–µ—Ä—Ö
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    vibrate(30);
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('open');
    vibrate(50);
}

/* ================================================================
   11. FLASHCARDS (—Ä–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫)
   ================================================================ */
function switchVocabMode(mode) {
    currentVocabMode = mode;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º—ã
    document.querySelectorAll('.vocab-mode').forEach(m => m.classList.remove('active'));
    
    if (mode === 'list') {
        document.getElementById('vocabList').classList.add('active');
    } else {
        document.getElementById('vocabFlashcards').classList.add('active');
        currentCard = 0;
        showCard(0);
    }
    
    vibrate(30);
}

function flipCard(index) {
    const card = document.getElementById(`card-${index}`);
    if (card) {
        card.classList.toggle('flipped');
        vibrate(30);
    }
}

function showCard(index) {
    const totalCards = lessonData.content.vocabulary.words.length;
    
    if (index < 0 || index >= totalCards) return;
    
    // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç–æ—á–∫–∏
    document.querySelectorAll('.flashcard').forEach(card => {
        card.classList.remove('active', 'flipped');
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é
    const card = document.getElementById(`card-${index}`);
    if (card) {
        card.classList.add('active');
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
    document.getElementById('cardCounter').textContent = `${index + 1} / ${totalCards}`;
    
    currentCard = index;
}

function nextCard() {
    const totalCards = lessonData.content.vocabulary.words.length;
    if (currentCard < totalCards - 1) {
        showCard(currentCard + 1);
        vibrate(30);
    } else {
        showNotification('üéâ You reached the last card!');
    }
}

function prevCard() {
    if (currentCard > 0) {
        showCard(currentCard - 1);
        vibrate(30);
    } else {
        showNotification('üìç This is the first card');
    }
}
/* ================================================================
   12. UTILITY FUNCTIONS (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
   ================================================================ */

// –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ HTML –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è XSS
function escapeJS(str) {
    if (typeof str !== 'string') return '';
    
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// –í–∏–±—Ä–∞—Ü–∏—è (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è)
function vibrate(pattern) {
    if ('vibrate' in navigator) {
        navigator.vibrate(pattern);
    }
}

// –ü–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showNotification(message, duration = 2000) {
    const notification = document.getElementById('notification');
    if (!notification) return;
    
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, duration);
}

// Debounce —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

/* ================================================================
   13. EVENT LISTENERS
   ================================================================ */

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
document.addEventListener('keydown', (e) => {
    // ESC - –∑–∞–∫—Ä—ã—Ç—å sidebar
    if (e.key === 'Escape') {
        const sidebar = document.getElementById('sidebar');
        if (sidebar && sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
        }
    }
    
    // –°—Ç—Ä–µ–ª–∫–∏ –¥–ª—è flashcards (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ä–µ–∂–∏–º flashcards –∞–∫—Ç–∏–≤–µ–Ω)
    if (currentVocabMode === 'flashcards') {
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            prevCard();
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            nextCard();
        } else if (e.key === ' ' || e.key === 'Enter') {
            e.preventDefault();
            flipCard(currentCard);
        }
    }
});

// –ó–∞–∫—Ä—ã—Ç–∏–µ sidebar –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.addEventListener('click', (e) => {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.querySelector('.sidebar-toggle');
    
    if (sidebar && sidebar.classList.contains('open')) {
        if (!sidebar.contains(e.target) && !toggle.contains(e.target)) {
            sidebar.classList.remove('open');
        }
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ TTS –ø—Ä–∏ —Å–∫—Ä—ã—Ç–∏–∏)
document.addEventListener('visibilitychange', () => {
    if (document.hidden && window.speechSynthesis) {
        window.speechSynthesis.cancel();
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.listen-btn.playing').forEach(btn => {
            btn.classList.remove('playing');
            btn.innerHTML = 'üîä Listen';
        });
    }
});

// –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Å–ª—É—á–∞–π–Ω–æ–≥–æ –∑–∞–∫—Ä—ã—Ç–∏—è –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤ –∫–≤–∏–∑–µ
window.addEventListener('beforeunload', (e) => {
    if (quizScore.total > 0 && quizScore.total < (lessonData?.quiz?.length || 0)) {
        e.preventDefault();
        e.returnValue = 'You have unsaved quiz progress. Are you sure you want to leave?';
        return e.returnValue;
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–µ—Å–ª–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã)
document.addEventListener('error', (e) => {
    if (e.target.tagName === 'IMG') {
        e.target.style.display = 'none';
        console.warn('Image failed to load:', e.target.src);
    }
}, true);

/* ================================================================
   14. INITIALIZATION (–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
   ================================================================ */

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ DOM
document.addEventListener('DOMContentLoaded', () => {
    console.log(`%cüìö Lesson ${lessonId} Loading...`, 'color: #00838F; font-size: 16px; font-weight: bold;');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ LocalStorage
    try {
        localStorage.setItem('test', 'test');
        localStorage.removeItem('test');
    } catch (e) {
        console.warn('LocalStorage not available:', e);
        showNotification('‚ö†Ô∏è Word saving may not work in this browser');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ Web Speech API
    if (!window.speechSynthesis) {
        console.warn('Web Speech API not supported');
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—Ä–æ–∫
    loadLesson();
});

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
window.addEventListener('load', () => {
    if (lessonData) {
        console.log(`%c‚úÖ Lesson "${lessonData.title}" loaded successfully!`, 'color: #34C759; font-size: 14px; font-weight: bold;');
        console.log(`üìä Stats:`, {
            readingBlocks: lessonData.content.reading?.length || 0,
            vocabularyWords: lessonData.content.vocabulary?.words?.length || 0,
            phrases: lessonData.content.vocabulary?.phrases?.length || 0,
            grammarRules: lessonData.content.grammar?.length || 0,
            quizQuestions: lessonData.quiz?.length || 0
        });
    }
});

// –£–ª—É—á—à–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
window.addEventListener('error', (e) => {
    console.error('Global error:', e.error);
    
    // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –Ω–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
    if (e.error && e.error.message && !e.error.message.includes('ResizeObserver')) {
        showNotification('‚ö†Ô∏è An error occurred. Check console for details.');
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–º–∏—Å–æ–≤
window.addEventListener('unhandledrejection', (e) => {
    console.error('Unhandled promise rejection:', e.reason);
    showNotification('‚ö†Ô∏è Network or loading error occurred');
});

// Service Worker –¥–ª—è offline —Ä–∞–±–æ—Ç—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è SW –æ—Ç–∫–ª—é—á–µ–Ω–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        // –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è PWA —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
        /*
        navigator.serviceWorker.register('/sw.js')
            .then(reg => console.log('ServiceWorker registered:', reg))
            .catch(err => console.log('ServiceWorker registration failed:', err));
        */
    });
}

// –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –ª–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
if ('IntersectionObserver' in window) {
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;
                if (img.dataset.src) {
                    img.src = img.dataset.src;
                    img.removeAttribute('data-src');
                    observer.unobserve(img);
                }
            }
        });
    });
    
    // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (–µ—Å–ª–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã)
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('img[data-src]').forEach(img => {
            imageObserver.observe(img);
        });
    });
}

// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–≤–∏–∑–∞ –≤ sessionStorage
function saveQuizProgress() {
    if (quizScore.total > 0) {
        try {
            sessionStorage.setItem(`lesson_${lessonId}_quiz_progress`, JSON.stringify({
                score: quizScore,
                timestamp: Date.now()
            }));
        } catch (e) {
            console.warn('Failed to save quiz progress:', e);
        }
    }
}

// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫–≤–∏–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
function restoreQuizProgress() {
    try {
        const saved = sessionStorage.getItem(`lesson_${lessonId}_quiz_progress`);
        if (saved) {
            const data = JSON.parse(saved);
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–µ —Å—Ç–∞—Ä—à–µ 24 —á–∞—Å–æ–≤
            if (Date.now() - data.timestamp < 24 * 60 * 60 * 1000) {
                // –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∑–¥–µ—Å—å
                console.log('Quiz progress found:', data);
            }
        }
    } catch (e) {
        console.warn('Failed to restore quiz progress:', e);
    }
}

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
setInterval(saveQuizProgress, 30000); // –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥

/* ================================================================
   15. –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –£–¢–ò–õ–ò–¢–´
   ================================================================ */

// –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
function copyToClipboard(text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text)
            .then(() => showNotification('üìã Copied to clipboard!'))
            .catch(err => console.error('Failed to copy:', err));
    } else {
        // Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showNotification('üìã Copied to clipboard!');
        } catch (err) {
            console.error('Failed to copy:', err);
        }
        document.body.removeChild(textarea);
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã—Ö —Å–ª–æ–≤ –≤ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
function exportMyWords() {
    if (myWords.length === 0) {
        showNotification('‚ö†Ô∏è No words to export');
        return;
    }
    
    let content = `My Words - Lesson ${lessonId}\n`;
    content += `Generated: ${new Date().toLocaleString()}\n\n`;
    
    myWords.forEach((word, index) => {
        content += `${index + 1}. ${word.en} - ${word.ru}\n`;
    });
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `lesson_${lessonId}_vocabulary.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showNotification('üì• Words exported!');
}

// –ü–µ—á–∞—Ç—å —É—Ä–æ–∫–∞
function printLesson() {
    window.print();
}

// –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –∫–≤–∏–∑–∞
function shareQuizResults() {
    const score = quizScore.correct;
    const total = lessonData.quiz.length;
    const percentage = Math.round((score / total) * 100);
    
    const text = `I scored ${score}/${total} (${percentage}%) on "${lessonData.title}" lesson! üéØ`;
    
    if (navigator.share) {
        navigator.share({
            title: 'My Quiz Results',
            text: text
        }).catch(err => console.log('Share failed:', err));
    } else {
        copyToClipboard(text);
    }
}

// –ö–æ–Ω—Å–æ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ (–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
window.debugLesson = {
    data: () => lessonData,
    words: () => myWords,
    score: () => quizScore,
    reset: () => {
        localStorage.clear();
        sessionStorage.clear();
        location.reload();
    },
    export: exportMyWords
};

console.log('%cüí° Tip: Use window.debugLesson for debugging', 'color: #FF9500; font-size: 12px;');

    </script>
</body>
</html>
