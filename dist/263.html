<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading lesson...</title>
    <style>
        :root {
            --bg: #ffffff;
            --text: #1d1d1f;
            --accent: #00838F; /* Будет перезаписано из JSON */
            --secondary: #F5F5F7;
            --border: #e1e1e1;
            --success: #34C759;
            --error: #FF3B30;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            line-height: 1.6;
            transition: background 0.3s, color 0.3s;
        }

        /* Темы */
        body.theme-dark { --bg: #1c1c1e; --text: #f5f5f7; --secondary: #2c2c2e; --border: #3a3a3c; }
        
        .container { max-width: 700px; margin: 0 auto; padding: 20px 20px 100px 20px; }
        
        /* Заголовок урока */
        header { margin-bottom: 40px; text-align: center; }
        .lesson-title { font-size: 2rem; margin: 0 0 10px 0; letter-spacing: -0.02em; color: var(--text); }
        .lesson-subtitle { color: #888; font-size: 1.1rem; font-weight: 400; }
        
        /* Общие стили блоков */
        .block { margin-bottom: 50px; animation: fadeIn 0.5s ease; }
        .block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .block-title { margin: 0; font-size: 1.4rem; font-weight: 700; color: var(--accent); }
        
        /* Текст для чтения */
        .reading-text { font-size: 1.1rem; text-align: justify; }
        
        /* Интерактивные слова */
        .word { cursor: pointer; border-radius: 4px; transition: 0.1s; }
        .word:hover { background-color: rgba(0,0,0, 0.05); color: var(--accent); }
        body.theme-dark .word:hover { background-color: rgba(255,255,255, 0.1); }
        .word.active { background-color: var(--accent); color: white !important; }
        
        /* Кнопка Listen */
        .listen-btn {
            background: var(--secondary); border: none; padding: 8px 16px; 
            border-radius: 20px; color: var(--accent); font-weight: 600; cursor: pointer;
            font-size: 0.9rem; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px;
        }
        .listen-btn:hover { background: #e0e0e0; transform: scale(1.02); }
        .listen-btn.playing { background: var(--accent); color: white; }
        
        /* Fact Block */
        .block--fact .fact-box {
            background: var(--secondary); padding: 25px; border-radius: 12px; 
            border-left: 5px solid var(--accent); position: relative;
        }
        .fact-box__title { 
            font-weight: 900; font-size: 0.75rem; letter-spacing: 1.5px; 
            color: var(--accent); margin-bottom: 10px; text-transform: uppercase; 
        }
        .fact-box__text { font-style: italic; font-size: 1.05rem; }

        /* Vocabulary Grid */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .v-item {
            background: var(--secondary); padding: 15px; border-radius: 12px; 
            cursor: pointer; text-align: center; transition: 0.2s; border: 1px solid transparent;
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .v-item:hover { border-color: var(--accent); transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .v-item .en { display: block; font-weight: 700; color: var(--accent); margin-bottom: 6px; font-size: 1.05rem; }
        .v-item .ru { display: block; font-size: 0.9rem; color: #777; line-height: 1.2; }

        /* Phrases List */
        .p-list { display: flex; flex-direction: column; gap: 12px; }
        .p-item {
            display: flex; align-items: center; padding: 16px; border-radius: 12px;
            background: var(--secondary); cursor: pointer; transition: 0.2s;
        }
        .p-item:hover { background: #eee; padding-left: 20px; }
        body.theme-dark .p-item:hover { background: #333; }
        .p-text-group { flex-grow: 1; }
        .p-en { font-weight: 600; margin-bottom: 4px; font-size: 1.05rem; color: var(--text); }
        .p-ru { font-size: 0.9rem; color: #888; }
        .p-icon { color: var(--accent); font-size: 0.8rem; opacity: 0.5; }

        /* Quiz */
        .q-item { background: var(--bg); border: 1px solid var(--border); padding: 25px; border-radius: 16px; }
        .q-txt { display: block; font-weight: 700; font-size: 1.2rem; margin-bottom: 20px; }
        .opts { display: flex; flex-direction: column; gap: 10px; }
        .opt-btn {
            text-align: left; padding: 14px 18px; border: 2px solid var(--secondary);
            background: transparent; border-radius: 12px; cursor: pointer;
            font-size: 1rem; color: var(--text); transition: 0.2s; font-weight: 500;
        }
        .opt-btn:hover { border-color: #ccc; }
        .opt-btn.good { background: rgba(52, 199, 89, 0.15); border-color: var(--success); color: #2d8a42; }
        .opt-btn.bad { background: rgba(255, 59, 48, 0.15); border-color: var(--error); color: var(--error); opacity: 0.7; }
        .fb { margin-top: 20px; padding: 15px; background: var(--secondary); border-radius: 8px; display: none; animation: fadeIn 0.3s; }

        /* Utils */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .error-msg { color: var(--error); text-align: center; margin-top: 50px; }
    </style>
</head>
<body>

<div class="container">
    <div id="app">
        <h2 style="text-align:center; color:#ccc; margin-top: 100px; font-weight: 400;">Loading...</h2>
    </div>
</div>

<script>
    // --- 1. INIT & FETCH ---
    
    const lessonId = getLessonId();
    const dataUrl = `../data/${lessonId}.json`;

    fetch(dataUrl)
        .then(r => {
            if (!r.ok) throw new Error(`HTTP ${r.status}`);
            return r.json();
        })
        .then(data => renderLesson(data))
        .catch(err => {
            console.error(err);
            document.getElementById('app').innerHTML = `
                <div class="error-msg">
                    <h3>Oops!</h3>
                    <p>Cannot load lesson data (${lessonId}.json).</p>
                    <p style="font-size:0.8em; opacity:0.7">${err.message}</p>
                </div>`;
        });

    function getLessonId() {
        // Извлекает '263' из '.../dist/263.html'
        const path = window.location.pathname;
        const file = path.split('/').pop(); 
        return file.replace('.html', '') || '263'; // fallback для тестов
    }


    // --- 2. RENDER ---

    function renderLesson(data) {
        document.title = data.title || 'Lesson';
        
        // Применение цветов из JSON
        if (data.colors && data.colors.length) {
            document.documentElement.style.setProperty('--accent', data.colors[0]);
        }
        
        if (data.theme) document.body.classList.add(`theme-${data.theme}`);

        let html = `
            <header>
                <h1 class="lesson-title">${data.title}</h1>
                ${data.subtitle ? `<div class="lesson-subtitle">${data.subtitle}</div>` : ''}
            </header>
        `;

        if (Array.isArray(data.content)) {
            data.content.forEach((item, i) => {
                html += renderBlock(item, i);
            });
        }

        document.getElementById('app').innerHTML = html;
    }

    function renderBlock(item, idx) {
        // 1. Standard Block
        if (item.type === 'block') {
            return `
                <div class="block">
                    <div class="block-header">
                        <h3 class="block-title">${item.title || ''}</h3>
                        <button class="listen-btn" onclick="readBlock(this)">
                            <span class="icon">▶</span> Listen
                        </button>
                    </div>
                    <div class="reading-text interactive-text">
                        ${processText(item.text)}
                    </div>
                </div>
            `;
        }
        
        // 2. Fact
        if (item.type === 'fact') {
            return `
                <div class="block block--fact">
                    <div class="fact-box">
                        <div class="fact-box__title">Did you know?</div>
                        <div class="fact-box__text interactive-text">${processText(item.text)}</div>
                    </div>
                </div>
            `;
        }

        // 3. Vocabulary
        if (item.type === 'vocab') {
            const cards = item.items.map(w => `
                <div class="v-item" onclick="speakText('${esc(w.en)}')">
                    <span class="en">${w.en}</span>
                    <span class="ru">${w.ru}</span>
                </div>
            `).join('');
            return `
                <div class="block">
                    <h3 class="block-title">Vocabulary</h3>
                    <div class="grid">${cards}</div>
                </div>
            `;
        }

        // 4. Phrases
        if (item.type === 'phrase') {
            const list = item.items.map(ph => `
                <div class="p-item" onclick="speakText('${esc(ph.en)}')">
                    <div class="p-text-group">
                        <div class="p-en">${ph.en}</div>
                        <div class="p-ru">${ph.ru}</div>
                    </div>
                    <div class="p-icon">▶</div>
                </div>
            `).join('');
            return `
                <div class="block">
                    <h3 class="block-title">Phrases</h3>
                    <div class="p-list">${list}</div>
                </div>
            `;
        }

        // 5. Quiz
        if (item.type === 'quiz') {
            const opts = item.options.map((opt, i) => `
                <button class="opt-btn" data-index="${i}" onclick="checkQuiz(this, ${item.answer})">
                    ${opt}
                </button>
            `).join('');
            
            // Экранируем кавычки для data-attribute
            const safeFeedback = (item.feedback || '').replace(/"/g, '&quot;');
            
            return `
                <div class="block">
                    <div class="q-item" data-fb="${safeFeedback}">
                        <span class="q-txt">${item.question}</span>
                        <div class="opts">${opts}</div>
                        <div class="fb"></div>
                    </div>
                </div>
            `;
        }

        return '';
    }


    // --- 3. TEXT PROCESSING ---

    function processText(text) {
        if (!text) return '';
        // Простое разбиение на слова для кликабельности
        // Сначала экранируем HTML, если он есть (безопасность)
        // Но считаем, что в JSON доверенный контент.
        
        // Оборачиваем слова в span.word
        // Регулярка ищет последовательности букв/цифр/апострофов
        return text.replace(/([\w'’]+)/g, '<span class="word" onclick="speakWord(this)">$1</span>');
    }

    function esc(str) {
        return str.replace(/'/g, "\\'");
    }


    // --- 4. AUDIO & INTERACTION ---

    function speakText(text, onEnd) {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US'; // Можно 'en-GB' для британского акцента
        u.rate = 0.9;
        if (onEnd) u.onend = onEnd;
        window.speechSynthesis.speak(u);
    }

    function speakWord(el) {
        // Убираем активный класс с других
        document.querySelectorAll('.word.active').forEach(s => s.classList.remove('active'));
        
        el.classList.add('active');
        speakText(el.innerText, () => {
            setTimeout(() => el.classList.remove('active'), 500);
        });
    }

    function readBlock(btn) {
        if (btn.classList.contains('playing')) {
            window.speechSynthesis.cancel();
            btn.classList.remove('playing');
            btn.querySelector('.icon').innerText = '▶';
            btn.innerHTML = '<span class="icon">▶</span> Listen';
            return;
        }

        const block = btn.closest('.block');
        // Берем текст только из reading-text
        const container = block.querySelector('.reading-text');
        if (!container) return;
        
        const text = container.innerText;
        
        btn.classList.add('playing');
        btn.innerHTML = '<span class="icon">⏹</span> Stop';
        
        speakText(text, () => {
            btn.classList.remove('playing');
            btn.innerHTML = '<span class="icon">▶</span> Listen';
        });
    }


    // --- 5. QUIZ LOGIC ---

    function checkQuiz(btn, correctIdx) {
        const parent = btn.closest('.q-item');
        const allBtns = parent.querySelectorAll('.opt-btn');
        const fb = parent.querySelector('.fb');
        const feedbackTxt = parent.dataset.fb;
        const selectedIdx = parseInt(btn.dataset.index);

        // Блокируем все кнопки
        allBtns.forEach(b => {
            b.disabled = true;
            b.style.cursor = 'default';
            if (parseInt(b.dataset.index) === correctIdx) {
                b.classList.add('good'); // Показываем правильный всегда
            }
        });

        if (selectedIdx === correctIdx) {
            // Верно
            fb.innerHTML = `<strong style="color:var(--success)">Correct!</strong> ${feedbackTxt}`;
        } else {
            // Неверно
            btn.classList.add('bad');
            fb.innerHTML = `<strong style="color:var(--error)">Incorrect.</strong> ${feedbackTxt}`;
        }
        
        fb.style.display = 'block';
    }

</script>
</body>
</html>
