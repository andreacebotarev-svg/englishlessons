<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="referrer" content="no-referrer">
    <meta name="color-scheme" content="light dark">
    
    <!-- –í—Ä–µ–º–µ–Ω–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –∏–∑–º–µ–Ω–∏—Ç—Å—è JS-–æ–º -->
    <title>Loading lesson...</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å—Ç–∏–ª–µ–π -->
    <link rel="stylesheet" href="../style.css">
    
    <style>
        /* Fallback styles if CSS fails or loads late */
        body { margin: 0; font-family: sans-serif; background: #f5f5f7; }
        .loading-container { 
            display: flex; justify-content: center; align-items: center; 
            height: 80vh; color: #999; font-weight: 500; 
        }
        .error-msg { color: #e53935; text-align: center; margin-top: 50px; padding: 20px; }
        
        /* –°–∫—Ä—ã—Ç–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–æ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö */
        #app { opacity: 0; transition: opacity 0.4s ease; }
        #app.loaded { opacity: 1; }
    </style>
</head>
<body>

<!-- –ö–æ—Ä–Ω–µ–≤–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
<div class="container">
    <div id="app">
        <div class="loading-container">
            Loading lesson data...
        </div>
    </div>
</div>

<script>
    /**
     * EDUCATIONAL APP ENGINE v3.1
     * Handles JSON fetching, rendering, and interactivity.
     */
    
    // 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ ID —É—Ä–æ–∫–∞ –∏–∑ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞ (263.html -> 263)
    // –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è index.html (–¥–ª—è —Ç–µ—Å—Ç–æ–≤), —Ñ–æ–ª–ª–±–µ–∫ –Ω–∞ '263'
    const pathParts = window.location.pathname.split('/');
    const fileName = pathParts[pathParts.length - 1];
    const lessonId = fileName.replace('.html', '') || '263'; 

    console.log('Lesson ID detected:', lessonId);

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ JSON –¥–∞–Ω–Ω—ã—Ö
    const dataUrl = `../data/${lessonId}.json`;

    fetch(dataUrl)
        .then(response => {
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return response.json();
        })
        .then(data => {
            renderLesson(data);
        })
        .catch(error => {
            console.error('Load Error:', error);
            document.getElementById('app').innerHTML = `
                <div class="error-msg">
                    <h3>Error loading lesson</h3>
                    <p>Could not load data from de>${dataUrl}</code></p>
                    <p><small>Make sure you are running this via a Local Server (http://), not file://</small></p>
                </div>
            `;
        });

    /* --- CORE RENDERING LOGIC --- */
    
    function renderLesson(data) {
        // 1. –¢–µ–º–∏–∑–∞—Ü–∏—è
        document.title = data.title || 'Lesson';
        
        // –¶–≤–µ—Ç–∞
        if (data.colors && data.colors.length > 0) {
            const root = document.documentElement.style;
            root.setProperty('--accent', data.colors[0]);
            root.setProperty('--p', data.colors[0]);
            if (data.colors[1]) root.setProperty('--s', data.colors[1]);
        }
        
        // –ö–ª–∞—Å—Å —Ç–µ–º—ã
        if (data.theme) {
            document.body.classList.add(`theme-${data.theme}`);
        }

        // 2. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è HTML
        let html = '';

        // Header
        html += `
            <header>
                <h1 class="lesson-title">${data.title || 'Untitled Lesson'}</h1>
                ${data.subtitle ? `<div class="lesson-subtitle">${data.subtitle}</div>` : ''}
            </header>
        `;

        // Content Blocks
        if (data.content && Array.isArray(data.content)) {
            data.content.forEach((item, index) => {
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
                const delayStyle = `style="animation-delay: ${0.05 * (index + 1)}s"`;
                
                switch (item.type) {
                    case 'block':
                        html += generateBlock(item, delayStyle);
                        break;
                    case 'fact':
                        html += generateFact(item, delayStyle);
                        break;
                    case 'vocab':
                        html += generateVocab(item, delayStyle);
                        break;
                    case 'phrase':
                        html += generatePhrases(item, delayStyle);
                        break;
                    case 'quiz':
                        html += generateQuiz(item, delayStyle);
                        break;
                    default:
                        console.warn('Unknown block type:', item.type);
                        html += `<div class="block" ${delayStyle}><p style="color:red">Unsupported block type: ${item.type}</p></div>`;
                }
            });
        } else {
            html += '<div class="block"><p>No content available.</p></div>';
        }

        // 3. –í—Å—Ç–∞–≤–∫–∞ –≤ DOM
        const app = document.getElementById('app');
        app.innerHTML = html;
        
        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
        requestAnimationFrame(() => app.classList.add('loaded'));
    }

    // --- GENERATORS ---

    function generateBlock(item, style) {
        return `
            <div class="block" ${style}>
                <div class="block-header">
                    <h3 class="block-title">${item.title || ''}</h3>
                    <button class="listen-btn" onclick="readBlock(this)">‚ñ∂ Listen</button>
                </div>
                <div class="reading-text interactive-text">
                    ${processText(item.text || '')}
                </div>
            </div>
        `;
    }

    function generateFact(item, style) {
        return `
            <div class="block block--fact" ${style}>
                <div class="fact-box">
                    <div class="fact-box__title">FACT</div>
                    <div class="fact-box__text interactive-text">
                        ${processText(item.text || '')}
                    </div>
                </div>
            </div>
        `;
    }
    function generateVocab(item, style) {
        if (!item.items || item.items.length === 0) return '';
        
        const cards = item.items.map(word => `
            <div class="v-item" onclick="speakVocab(this)">
                <span class="en">${word.en}</span>
                <span class="ru">${word.ru}</span>
            </div>
        `).join('');

        return `
            <div class="block" ${style}>
                <h3 class="block-title">Vocabulary</h3>
                <div class="grid">
                    ${cards}
                </div>
            </div>
        `;
    }

    function generatePhrases(item, style) {
        if (!item.items || item.items.length === 0) return '';

        const rows = item.items.map(phrase => `
            <div class="p-item" onclick="speakPhrase(this)">
                <div class="p-text-group">
                    <div class="p-en">${phrase.en}</div>
                    <div class="p-ru">${phrase.ru}</div>
                </div>
                <div class="p-icon">‚ñ∂</div>
            </div>
        `).join('');

        return `
            <div class="block" ${style}>
                <h3 class="block-title">Phrases</h3>
                <div class="p-list">
                    ${rows}
                </div>
            </div>
        `;
    }

    function generateQuiz(item, style) {
        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
        const optionsHtml = item.options.map((opt, idx) => `
            <button class="opt-btn" 
                    data-index="${idx}" 
                    onclick="checkQuizOption(this, ${item.answer})">
                ${opt}
            </button>
        `).join('');

        // –°–∫—Ä—ã—Ç—ã–π —Ñ–∏–¥–±–µ–∫
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Ñ–∏–¥–±–µ–∫–∞ –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —á—Ç–æ–±—ã JS –º–æ–≥ –µ–≥–æ –¥–æ—Å—Ç–∞—Ç—å
        const feedbackText = (item.feedback || '').replace(/"/g, '&quot;');

        return `
            <div class="q-item" ${style} data-feedback="${feedbackText}">
                <span class="q-txt">${item.question}</span>
                <div class="opts">
                    ${optionsHtml}
                </div>
                <div class="fb" style="display:none;"></div>
            </div>
        `;
    }

    /* --- TEXT PROCESSING (The Magic Part) --- */

    /**
     * –ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç "Hello world [hl]grammar[/hl]" –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π HTML
     */
    function processText(rawText) {
        if (!rawText) return '';
        
        // 1. –ó–∞–º–µ–Ω–∞ —Å–ø–µ—Ü-—Ç–µ–≥–æ–≤ [hl]...[/hl] –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã, —á—Ç–æ–±—ã –Ω–µ —Å–ª–æ–º–∞—Ç—å –∏—Ö –ø—Ä–∏ —Ä–∞–∑–±–∏–≤–∫–µ —Å–ª–æ–≤
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç–æ—á–Ω–æ –Ω–µ –≤—Å—Ç—Ä–µ—Ç—è—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–µ
        let processed = rawText
            .replace(/\[hl\]/g, '___HL_START___')
            .replace(/\[\/hl\]/g, '___HL_END___');

        // 2. –†–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —Å–ª–æ–≤–∞ –∏ –æ–±–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ
        // –†–µ–≥—É–ª—è—Ä–∫–∞ –∏—â–µ—Ç —Å–ª–æ–≤–∞ (–±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, –∞–ø–æ—Å—Ç—Ä–æ—Ñ—ã), —Å–æ—Ö—Ä–∞–Ω—è—è –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è
        processed = processed.split(/(\s+|[.,!?;:()"])/).map(token => {
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –ø—É—Å—Ç–æ–π –∏–ª–∏ –ø—Ä–æ–±–µ–ª - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            if (!token.trim()) return token;
            
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —ç—Ç–æ –Ω–∞—à–∏ –º–∞—Ä–∫–µ—Ä—ã - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
            if (token.includes('___HL_')) return token;

            // –ï—Å–ª–∏ —ç—Ç–æ —Å–ª–æ–≤–æ (—Å–æ–¥–µ—Ä–∂–∏—Ç –±—É–∫–≤—ã) - –æ–±–æ—Ä–∞—á–∏–≤–∞–µ–º
            if (/[a-zA-Z0-9]/.test(token)) {
                // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏ –¥–ª—è onclick
                const safeWord = token.replace(/'/g, "\\'");
                return `<span class="word" onclick="speakWord('${safeWord}', this)">${token}</span>`;
            }
            
            return token;
        }).join('');

        // 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ [hl] —É–∂–µ –≤ –≤–∏–¥–µ HTML —Ç–µ–≥–æ–≤
        processed = processed
            .replace(/___HL_START___/g, '<span class="hl">')
            .replace(/___HL_END___/g, '</span>');

        return processed;
    }
    /* --- INTERACTIVITY & TTS --- */

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—á–µ—Ä–µ–¥—å –¥–ª—è TTS
    let currentUtterance = null;

    function speak(text, onEndCallback) {
        if (!window.speechSynthesis) return;
        
        // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–µ
        window.speechSynthesis.cancel();

        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'en-US'; // –ú–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –Ω–∞ en-GB
        u.rate = 0.95;    // –ß—É—Ç—å –∑–∞–º–µ–¥–ª–µ–Ω–Ω–æ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è
        
        // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —Ö–æ—Ä–æ—à–∏–π –≥–æ–ª–æ—Å
        const voices = window.speechSynthesis.getVoices();
        const preferredVoice = voices.find(v => v.name.includes('Google US English')) 
                            || voices.find(v => v.name.includes('Samantha'))
                            || voices.find(v => v.lang.startsWith('en'));
        
        if (preferredVoice) u.voice = preferredVoice;

        if (onEndCallback) {
            u.onend = onEndCallback;
        }

        u.onerror = (e) => console.error('TTS Error:', e);
        
        window.speechSynthesis.speak(u);
        currentUtterance = u;
    }

    // 1. –û–∑–≤—É—á–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–ª–æ–≤–∞
    window.speakWord = function(word, el) {
        // –í–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
        document.querySelectorAll('.word.active').forEach(w => w.classList.remove('active'));
        if (el) el.classList.add('active');

        speak(word, () => {
            if (el) setTimeout(() => el.classList.remove('active'), 200);
        });
    };

    // 2. –û–∑–≤—É—á–∫–∞ –±–ª–æ–∫–∞ —Ç–µ–∫—Å—Ç–∞
    window.readBlock = function(btn) {
        const block = btn.closest('.block');
        // –ë–µ—Ä–µ–º —á–∏—Å—Ç—ã–π —Ç–µ–∫—Å—Ç –±–µ–∑ HTML —Ç–µ–≥–æ–≤
        const textContainer = block.querySelector('.reading-text');
        const text = textContainer.innerText;

        if (btn.classList.contains('playing')) {
            window.speechSynthesis.cancel();
            btn.classList.remove('playing');
            btn.innerHTML = '‚ñ∂ Listen';
            return;
        }

        // –°–±—Ä–æ—Å –¥—Ä—É–≥–∏—Ö –∫–Ω–æ–ø–æ–∫
        document.querySelectorAll('.listen-btn').forEach(b => {
            b.classList.remove('playing');
            b.innerHTML = '‚ñ∂ Listen';
        });

        btn.classList.add('playing');
        btn.innerHTML = '‚èπ Stop';

        speak(text, () => {
            btn.classList.remove('playing');
            btn.innerHTML = '‚ñ∂ Listen';
        });
    };

    // 3. –û–∑–≤—É—á–∫–∞ Vocab Card
    window.speakVocab = function(el) {
        const enText = el.querySelector('.en').innerText;
        
        // –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞–∂–∞—Ç–∏—è
        el.style.transform = 'scale(0.95)';
        setTimeout(() => el.style.transform = '', 150);
        
        speak(enText);
    };

    // 4. –û–∑–≤—É—á–∫–∞ Phrase Item
    window.speakPhrase = function(el) {
        const enText = el.querySelector('.p-en').innerText;
        const icon = el.querySelector('.p-icon');
        
        const originalIcon = icon.innerText;
        icon.innerText = 'üîä';
        el.style.background = 'var(--bg-muted, #eee)'; // –ü–æ–¥—Å–≤–µ—Ç–∫–∞

        speak(enText, () => {
            icon.innerText = originalIcon;
            el.style.background = '';
        });
    };

    /* --- QUIZ LOGIC --- */

    window.checkQuizOption = function(btn, correctIndex) {
        const parent = btn.closest('.q-item');
        const allBtns = parent.querySelectorAll('.opt-btn');
        const feedbackEl = parent.querySelector('.fb');
        const selectedIndex = parseInt(btn.dataset.index);
        
        // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è, –µ—Å–ª–∏ —É–∂–µ —É–≥–∞–¥–∞–ª–∏? (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        // –ó–¥–µ—Å—å —Ä–∞–∑—Ä–µ—à–∞–µ–º –º–µ–Ω—è—Ç—å –æ—Ç–≤–µ—Ç, –ø—Ä–æ—Å—Ç–æ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏
        
        allBtns.forEach(b => {
            b.classList.remove('good', 'bad');
            // b.disabled = true; // –ï—Å–ª–∏ —Ö–æ—Ç–∏–º –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∫–ª–∏–∫–∞
        });

        feedbackEl.style.display = 'block';
        feedbackEl.className = 'fb'; // –°–±—Ä–æ—Å –∞–Ω–∏–º–∞—Ü–∏–∏

        if (selectedIndex === correctIndex) {
            btn.classList.add('good');
            
            // –ë–µ—Ä–µ–º —Ç–µ–∫—Å—Ç —Ñ–∏–¥–±–µ–∫–∞ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–∞ (–æ–Ω —Ç–∞–º —Å–ø—Ä—è—Ç–∞–Ω)
            const fbText = parent.dataset.feedback || 'Correct! Well done.';
            feedbackEl.innerText = fbText;
            feedbackEl.style.color = 'var(--accent-success, #34C759)';
            feedbackEl.style.background = 'var(--accent-success-bg, #E8F8EA)';
            
            // –ó–≤—É–∫ —É—Å–ø–µ—Ö–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –±–∏–ø)
        } else {
            btn.classList.add('bad');
            feedbackEl.innerText = 'Try again!';
            feedbackEl.style.color = 'var(--accent-error, #FF3B30)';
            feedbackEl.style.background = 'var(--accent-error-bg, #FFF0F0)';
            
            // –í–∏–±—Ä–∞—Ü–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            if (navigator.vibrate) navigator.vibrate(200);
        }
    };

    // Fix for Chrome voice loading async issue
    if (window.speechSynthesis) {
        window.speechSynthesis.onvoiceschanged = () => {
            window.speechSynthesis.getVoices();
        };
    }

</script>
</body>
</html>
